<!DOCTYPE html>
<html lang="en">
  <head>
    
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    
    <title>Database Abstraction Layer — Phalcon 2.0.0 documentation</title>
    <meta name="keywords" content="php, phalcon, phalcon php, php framework, faster php framework">
<link rel="stylesheet" type="text/css" href="http://netdna.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="http://static.phalconphp.com/css/phalcon.min.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:700,400" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Merriweather:400,700" rel="stylesheet" type="text/css">
    <!--
    EUROPE <link href='https://fonts.googleapis.com/css?family=Open+Sans:700,400&subset=latin-ext' rel='stylesheet' type='text/css'>
    GREEK <link href='https://fonts.googleapis.com/css?family=Open+Sans:700,400&subset=greek-ext' rel='stylesheet' type='text/css'>
    RUSSIA <link href='https://fonts.googleapis.com/css?family=Open+Sans:700,400&subset=cyrillic-ext,latin' rel='stylesheet' type='text/css'>
    -->

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link rel="stylesheet" href="../_static/pygments.css" type="text/css">
    <link rel="stylesheet" href="../_static/docs.css" type="text/css">
    

    
    
    <link rel="shortcut icon" href="../_static/favicon.ico">
    <link rel="top" title="Phalcon 2.0.0 documentation" href="../index.html">
    <link rel="next" title="Internationalization" href="intl.html">
    <link rel="prev" title="Queueing" href="queue.html"> 
  </head>
  <body>




    <!--<div class="header-line">
      <div class="size-wrap">
        <div class="header-line-title title-white">Documentation</div>
      </div>
    </div>-->
      

      <table width="100%" align="center" cellpadding="0" cellspacing="0">
        <tr>
      
          <td class="second-box" valign="top">
            <div class="document">
                <div class="documentwrapper">
                  <div class="bodywrapper">
                    <div class="body">
                      
  <div class="section" id="database-abstraction-layer">
<h1>Database Abstraction Layer</h1>
<p><a class="reference internal" href="../api/Phalcon_Db.html"><em>Phalcon\Db</em></a> is the component behind <a class="reference internal" href="../api/Phalcon_Mvc_Model.html"><em>Phalcon\Mvc\Model</em></a> that powers the model layer
in the framework. It consists of an independent high-level abstraction layer for database systems completely written in C.</p>
<p>This component allows for a lower level database manipulation than using traditional models.</p>
<blockquote class="highlights">
<div>This guide is not intended to be a complete documentation of available methods and their arguments. Please visit the <a class="reference internal" href="../api/index.html"><em>API</em></a>
for a complete reference.</div>
</blockquote>
<div class="section" id="database-adapters">
<h2>Database Adapters<a class="headerlink" href="db.html#database-adapters" title="Permalink to this headline">¶</a>
</h2>
<p>This component makes use of adapters to encapsulate specific database system details. Phalcon uses <a class="reference external" href="http://www.php.net/manual/en/book.pdo.php">PDO</a> to connect to databases. The following
database engines are supported:</p>
<table border="1" class="docutils">
<colgroup>
<col width="4%">
<col width="69%">
<col width="27%">
</colgroup>
<thead valign="bottom">
<tr class="row-odd">
<th class="head">Name</th>
<th class="head">Description</th>
<th class="head">API</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even">
<td>MySQL</td>
<td>Is the world’s most used relational database management system (RDBMS) that runs as a server providing multi-user access to a number of databases</td>
<td><a class="reference internal" href="../api/Phalcon_Db_Adapter_Pdo_Mysql.html"><em>Phalcon\Db\Adapter\Pdo\Mysql</em></a></td>
</tr>
<tr class="row-odd">
<td>PostgreSQL</td>
<td>PostgreSQL is a powerful, open source relational database system. It has more than 15 years of active development and a proven architecture that has earned it a strong reputation for reliability, data integrity, and correctness.</td>
<td><a class="reference internal" href="../api/Phalcon_Db_Adapter_Pdo_Postgresql.html"><em>Phalcon\Db\Adapter\Pdo\Postgresql</em></a></td>
</tr>
<tr class="row-even">
<td>SQLite</td>
<td>SQLite is a software library that implements a self-contained, serverless, zero-configuration, transactional SQL database engine</td>
<td><a class="reference internal" href="../api/Phalcon_Db_Adapter_Pdo_Sqlite.html"><em>Phalcon\Db\Adapter\Pdo\Sqlite</em></a></td>
</tr>
<tr class="row-odd">
<td>Oracle</td>
<td>Oracle is an object-relational database management system produced and marketed by Oracle Corporation.</td>
<td><a class="reference internal" href="../api/Phalcon_Db_Adapter_Pdo_Oracle.html"><em>Phalcon\Db\Adapter\Pdo\Oracle</em></a></td>
</tr>
</tbody>
</table>
<div class="section" id="implementing-your-own-adapters">
<h3>Implementing your own adapters<a class="headerlink" href="db.html#implementing-your-own-adapters" title="Permalink to this headline">¶</a>
</h3>
<p>The <a class="reference internal" href="../api/Phalcon_Db_AdapterInterface.html"><em>Phalcon\Db\AdapterInterface</em></a> interface must be implemented in order to create your own
database adapters or extend the existing ones.</p>
</div>
</div>
<div class="section" id="database-dialects">
<h2>Database Dialects<a class="headerlink" href="db.html#database-dialects" title="Permalink to this headline">¶</a>
</h2>
<p>Phalcon encapsulates the specific details of each database engine in dialects. Those provide common functions and SQL generator to the adapters.</p>
<table border="1" class="docutils">
<colgroup>
<col width="8%">
<col width="37%">
<col width="55%">
</colgroup>
<thead valign="bottom">
<tr class="row-odd">
<th class="head">Name</th>
<th class="head">Description</th>
<th class="head">API</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even">
<td>MySQL</td>
<td>SQL specific dialect for MySQL database system</td>
<td><a class="reference internal" href="../api/Phalcon_Db_Dialect_Mysql.html"><em>Phalcon\Db\Dialect\Mysql</em></a></td>
</tr>
<tr class="row-odd">
<td>PostgreSQL</td>
<td>SQL specific dialect for PostgreSQL database system</td>
<td><a class="reference internal" href="../api/Phalcon_Db_Dialect_Postgresql.html"><em>Phalcon\Db\Dialect\Postgresql</em></a></td>
</tr>
<tr class="row-even">
<td>SQLite</td>
<td>SQL specific dialect for SQLite database system</td>
<td><a class="reference internal" href="../api/Phalcon_Db_Dialect_Sqlite.html"><em>Phalcon\Db\Dialect\Sqlite</em></a></td>
</tr>
<tr class="row-odd">
<td>Oracle</td>
<td>SQL specific dialect for Oracle database system</td>
<td><a class="reference internal" href="../api/Phalcon_Db_Dialect_Oracle.html"><em>Phalcon\Db\Dialect\Oracle</em></a></td>
</tr>
</tbody>
</table>
<div class="section" id="implementing-your-own-dialects">
<h3>Implementing your own dialects<a class="headerlink" href="db.html#implementing-your-own-dialects" title="Permalink to this headline">¶</a>
</h3>
<p>The <a class="reference internal" href="../api/Phalcon_Db_DialectInterface.html"><em>Phalcon\Db\DialectInterface</em></a> interface must be implemented in order to create your own database dialects or extend the existing ones.</p>
</div>
</div>
<div class="section" id="connecting-to-databases">
<h2>Connecting to Databases<a class="headerlink" href="db.html#connecting-to-databases" title="Permalink to this headline">¶</a>
</h2>
<p>To create a connection it’s necessary instantiate the adapter class. It only requires an array with the connection parameters. The example
below shows how to create a connection passing both required and optional parameters:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Required</span>
<span class="nv">$config</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s2">"host"</span> <span class="o">=&gt;</span> <span class="s2">"127.0.0.1"</span><span class="p">,</span>
    <span class="s2">"username"</span> <span class="o">=&gt;</span> <span class="s2">"mike"</span><span class="p">,</span>
    <span class="s2">"password"</span> <span class="o">=&gt;</span> <span class="s2">"sigma"</span><span class="p">,</span>
    <span class="s2">"dbname"</span> <span class="o">=&gt;</span> <span class="s2">"test_db"</span>
<span class="p">);</span>

<span class="c1">// Optional</span>
<span class="nv">$config</span><span class="p">[</span><span class="s2">"persistent"</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>

<span class="c1">// Create a connection</span>
<span class="nv">$connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Phalcon\Db\Adapter\Pdo\Mysql</span><span class="p">(</span><span class="nv">$config</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Required</span>
<span class="nv">$config</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s2">"host"</span> <span class="o">=&gt;</span> <span class="s2">"localhost"</span><span class="p">,</span>
    <span class="s2">"username"</span> <span class="o">=&gt;</span> <span class="s2">"postgres"</span><span class="p">,</span>
    <span class="s2">"password"</span> <span class="o">=&gt;</span> <span class="s2">"secret1"</span><span class="p">,</span>
    <span class="s2">"dbname"</span> <span class="o">=&gt;</span> <span class="s2">"template"</span>
<span class="p">);</span>

<span class="c1">// Optional</span>
<span class="nv">$config</span><span class="p">[</span><span class="s2">"schema"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"public"</span><span class="p">;</span>

<span class="c1">// Create a connection</span>
<span class="nv">$connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Phalcon\Db\Adapter\Pdo\Postgresql</span><span class="p">(</span><span class="nv">$config</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Required</span>
<span class="nv">$config</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s2">"dbname"</span> <span class="o">=&gt;</span> <span class="s2">"/path/to/database.db"</span>
<span class="p">);</span>

<span class="c1">// Create a connection</span>
<span class="nv">$connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Phalcon\Db\Adapter\Pdo\Sqlite</span><span class="p">(</span><span class="nv">$config</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Basic configuration</span>
<span class="nv">$config</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'username'</span> <span class="o">=&gt;</span> <span class="s1">'scott'</span><span class="p">,</span>
    <span class="s1">'password'</span> <span class="o">=&gt;</span> <span class="s1">'tiger'</span><span class="p">,</span>
    <span class="s1">'dbname'</span> <span class="o">=&gt;</span> <span class="s1">'192.168.10.145/orcl'</span><span class="p">,</span>
<span class="p">);</span>

<span class="c1">// Advanced configuration</span>
<span class="nv">$config</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'dbname'</span> <span class="o">=&gt;</span> <span class="s1">'(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=TCP)(HOST=localhost)(PORT=1521)))(CONNECT_DATA=(SERVICE_NAME=xe)(FAILOVER_MODE=(TYPE=SELECT)(METHOD=BASIC)(RETRIES=20)(DELAY=5))))'</span><span class="p">,</span>
    <span class="s1">'username'</span> <span class="o">=&gt;</span> <span class="s1">'scott'</span><span class="p">,</span>
    <span class="s1">'password'</span> <span class="o">=&gt;</span> <span class="s1">'tiger'</span><span class="p">,</span>
    <span class="s1">'charset'</span> <span class="o">=&gt;</span> <span class="s1">'AL32UTF8'</span><span class="p">,</span>
<span class="p">);</span>

<span class="c1">// Create a connection</span>
<span class="nv">$connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Phalcon\Db\Adapter\Pdo\Oracle</span><span class="p">(</span><span class="nv">$config</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="setting-up-additional-pdo-options">
<h2>Setting up additional PDO options<a class="headerlink" href="db.html#setting-up-additional-pdo-options" title="Permalink to this headline">¶</a>
</h2>
<p>You can set PDO options at connection time by passing the parameters ‘options’:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Create a connection with PDO options</span>
<span class="nv">$connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Phalcon\Db\Adapter\Pdo\Mysql</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s2">"host"</span> <span class="o">=&gt;</span> <span class="s2">"localhost"</span><span class="p">,</span>
    <span class="s2">"username"</span> <span class="o">=&gt;</span> <span class="s2">"root"</span><span class="p">,</span>
    <span class="s2">"password"</span> <span class="o">=&gt;</span> <span class="s2">"sigma"</span><span class="p">,</span>
    <span class="s2">"dbname"</span> <span class="o">=&gt;</span> <span class="s2">"test_db"</span><span class="p">,</span>
    <span class="s2">"options"</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="nx">PDO</span><span class="o">::</span><span class="na">MYSQL_ATTR_INIT_COMMAND</span> <span class="o">=&gt;</span> <span class="s2">"SET NAMES \'UTF8\'"</span><span class="p">,</span>
        <span class="nx">PDO</span><span class="o">::</span><span class="na">ATTR_CASE</span> <span class="o">=&gt;</span> <span class="nx">PDO</span><span class="o">::</span><span class="na">CASE_LOWER</span>
    <span class="p">)</span>
<span class="p">));</span>
</pre></div>
</div>
</div>
<div class="section" id="finding-rows">
<h2>Finding Rows<a class="headerlink" href="db.html#finding-rows" title="Permalink to this headline">¶</a>
</h2>
<p><a class="reference internal" href="../api/Phalcon_Db.html"><em>Phalcon\Db</em></a> provides several methods to query rows from tables. The specific SQL syntax of the target database engine is required in this case:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"SELECT id, name FROM robots ORDER BY name"</span><span class="p">;</span>

<span class="c1">// Send a SQL statement to the database system</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>

<span class="c1">// Print each robot name</span>
<span class="k">while</span> <span class="p">(</span><span class="nv">$robot</span> <span class="o">=</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">fetch</span><span class="p">())</span> <span class="p">{</span>
   <span class="k">echo</span> <span class="nv">$robot</span><span class="p">[</span><span class="s2">"name"</span><span class="p">];</span>
<span class="p">}</span>

<span class="c1">// Get all rows in an array</span>
<span class="nv">$robots</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$robots</span> <span class="k">as</span> <span class="nv">$robot</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">echo</span> <span class="nv">$robot</span><span class="p">[</span><span class="s2">"name"</span><span class="p">];</span>
<span class="p">}</span>

<span class="c1">// Get only the first row</span>
<span class="nv">$robot</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">fetchOne</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
</pre></div>
</div>
<p>By default these calls create arrays with both associative and numeric indexes. You can change this behavior by using Phalcon\Db\Result::setFetchMode(). This method receives a constant, defining which kind of index is required.</p>
<table border="1" class="docutils">
<colgroup>
<col width="31%">
<col width="69%">
</colgroup>
<thead valign="bottom">
<tr class="row-odd">
<th class="head">Constant</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even">
<td>Phalcon\Db::FETCH_NUM</td>
<td>Return an array with numeric indexes</td>
</tr>
<tr class="row-odd">
<td>Phalcon\Db::FETCH_ASSOC</td>
<td>Return an array with associative indexes</td>
</tr>
<tr class="row-even">
<td>Phalcon\Db::FETCH_BOTH</td>
<td>Return an array with both associative and numeric indexes</td>
</tr>
<tr class="row-odd">
<td>Phalcon\Db::FETCH_OBJ</td>
<td>Return an object instead of an array</td>
</tr>
</tbody>
</table>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"SELECT id, name FROM robots ORDER BY name"</span><span class="p">;</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>

<span class="nv">$result</span><span class="o">-&gt;</span><span class="na">setFetchMode</span><span class="p">(</span><span class="nx">Phalcon\Db</span><span class="o">::</span><span class="na">FETCH_NUM</span><span class="p">);</span>
<span class="k">while</span> <span class="p">(</span><span class="nv">$robot</span> <span class="o">=</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">fetch</span><span class="p">())</span> <span class="p">{</span>
   <span class="k">echo</span> <span class="nv">$robot</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The Phalcon\Db::query() returns an instance of <a class="reference internal" href="../api/Phalcon_Db_Result_Pdo.html"><em>Phalcon\Db\Result\Pdo</em></a>. These objects encapsulate all the functionality related to the returned resultset i.e. traversing, seeking specific records, count etc.</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"SELECT id, name FROM robots"</span><span class="p">;</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>

<span class="c1">// Traverse the resultset</span>
<span class="k">while</span> <span class="p">(</span><span class="nv">$robot</span> <span class="o">=</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">fetch</span><span class="p">())</span> <span class="p">{</span>
   <span class="k">echo</span> <span class="nv">$robot</span><span class="p">[</span><span class="s2">"name"</span><span class="p">];</span>
<span class="p">}</span>

<span class="c1">// Seek to the third row</span>
<span class="nv">$result</span><span class="o">-&gt;</span><span class="na">seek</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="nv">$robot</span> <span class="o">=</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">fetch</span><span class="p">();</span>

<span class="c1">// Count the resultset</span>
<span class="k">echo</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">numRows</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="binding-parameters">
<h2>Binding Parameters<a class="headerlink" href="db.html#binding-parameters" title="Permalink to this headline">¶</a>
</h2>
<p>Bound parameters is also supported in <a class="reference internal" href="../api/Phalcon_Db.html"><em>Phalcon\Db</em></a>. Although there is a minimal performance impact by using
bound parameters, you are encouraged to use this methodology so as to eliminate the possibility of your code being subject to SQL
injection attacks. Both string and positional placeholders are supported. Binding parameters can simply be achieved as follows:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Binding with numeric placeholders</span>
<span class="nv">$sql</span>    <span class="o">=</span> <span class="s2">"SELECT * FROM robots WHERE name = ? ORDER BY name"</span><span class="p">;</span>
<span class="nv">$result</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s2">"Wall-E"</span><span class="p">));</span>

<span class="c1">// Binding with named placeholders</span>
<span class="nv">$sql</span>     <span class="o">=</span> <span class="s2">"INSERT INTO `robots`(name`, year) VALUES (:name, :year)"</span><span class="p">;</span>
<span class="nv">$success</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s2">"name"</span> <span class="o">=&gt;</span> <span class="s2">"Astro Boy"</span><span class="p">,</span> <span class="s2">"year"</span> <span class="o">=&gt;</span> <span class="mi">1952</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="section" id="inserting-updating-deleting-rows">
<h2>Inserting/Updating/Deleting Rows<a class="headerlink" href="db.html#inserting-updating-deleting-rows" title="Permalink to this headline">¶</a>
</h2>
<p>To insert, update or delete rows, you can use raw SQL or use the preset functions provided by the class:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Inserting data with a raw SQL statement</span>
<span class="nv">$sql</span>     <span class="o">=</span> <span class="s2">"INSERT INTO `robots`(`name`, `year`) VALUES ('Astro Boy', 1952)"</span><span class="p">;</span>
<span class="nv">$success</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>

<span class="c1">//With placeholders</span>
<span class="nv">$sql</span>     <span class="o">=</span> <span class="s2">"INSERT INTO `robots`(`name`, `year`) VALUES (?, ?)"</span><span class="p">;</span>
<span class="nv">$success</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="nv">$sql</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'Astro Boy'</span><span class="p">,</span> <span class="mi">1952</span><span class="p">));</span>

<span class="c1">// Generating dynamically the necessary SQL</span>
<span class="nv">$success</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span>
   <span class="s2">"robots"</span><span class="p">,</span>
   <span class="k">array</span><span class="p">(</span><span class="s2">"Astro Boy"</span><span class="p">,</span> <span class="mi">1952</span><span class="p">),</span>
   <span class="k">array</span><span class="p">(</span><span class="s2">"name"</span><span class="p">,</span> <span class="s2">"year"</span><span class="p">)</span>
<span class="p">);</span>

<span class="c1">// Generating dynamically the necessary SQL (another syntax)</span>
<span class="nv">$success</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">insertAsDict</span><span class="p">(</span>
   <span class="s2">"robots"</span><span class="p">,</span>
   <span class="k">array</span><span class="p">(</span>
      <span class="s2">"name"</span> <span class="o">=&gt;</span> <span class="s2">"Astro Boy"</span><span class="p">,</span>
      <span class="s2">"year"</span> <span class="o">=&gt;</span> <span class="mi">1952</span>
   <span class="p">)</span>
<span class="p">);</span>

<span class="c1">// Updating data with a raw SQL statement</span>
<span class="nv">$sql</span>     <span class="o">=</span> <span class="s2">"UPDATE `robots` SET `name` = 'Astro boy' WHERE `id` = 101"</span><span class="p">;</span>
<span class="nv">$success</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>

<span class="c1">//With placeholders</span>
<span class="nv">$sql</span>     <span class="o">=</span> <span class="s2">"UPDATE `robots` SET `name` = ? WHERE `id` = ?"</span><span class="p">;</span>
<span class="nv">$success</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="nv">$sql</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'Astro Boy'</span><span class="p">,</span> <span class="mi">101</span><span class="p">));</span>

<span class="c1">// Generating dynamically the necessary SQL</span>
<span class="nv">$success</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span>
   <span class="s2">"robots"</span><span class="p">,</span>
   <span class="k">array</span><span class="p">(</span><span class="s2">"name"</span><span class="p">),</span>
   <span class="k">array</span><span class="p">(</span><span class="s2">"New Astro Boy"</span><span class="p">),</span>
   <span class="s2">"id = 101"</span> <span class="c1">//Warning! In this case values are not escaped</span>
<span class="p">);</span>

<span class="c1">// Generating dynamically the necessary SQL (another syntax)</span>
<span class="nv">$success</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">updateAsDict</span><span class="p">(</span>
   <span class="s2">"robots"</span><span class="p">,</span>
   <span class="k">array</span><span class="p">(</span>
      <span class="s2">"name"</span> <span class="o">=&gt;</span> <span class="s2">"New Astro Boy"</span>
   <span class="p">),</span>
   <span class="s2">"id = 101"</span> <span class="c1">//Warning! In this case values are not escaped</span>
<span class="p">);</span>

<span class="c1">//With escaping conditions</span>
<span class="nv">$success</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">(</span>
   <span class="s2">"robots"</span><span class="p">,</span>
   <span class="k">array</span><span class="p">(</span><span class="s2">"name"</span><span class="p">),</span>
   <span class="k">array</span><span class="p">(</span><span class="s2">"New Astro Boy"</span><span class="p">),</span>
   <span class="k">array</span><span class="p">(</span>
      <span class="s1">'conditions'</span> <span class="o">=&gt;</span> <span class="s1">'id = ?'</span><span class="p">,</span>
      <span class="s1">'bind'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="mi">101</span><span class="p">),</span>
      <span class="s1">'bindTypes'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_INT</span><span class="p">)</span> <span class="c1">//optional parameter</span>
   <span class="p">)</span>
<span class="p">);</span>
<span class="nv">$success</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">updateAsDict</span><span class="p">(</span>
   <span class="s2">"robots"</span><span class="p">,</span>
   <span class="k">array</span><span class="p">(</span>
      <span class="s2">"name"</span> <span class="o">=&gt;</span> <span class="s2">"New Astro Boy"</span>
   <span class="p">),</span>
   <span class="k">array</span><span class="p">(</span>
      <span class="s1">'conditions'</span> <span class="o">=&gt;</span> <span class="s1">'id = ?'</span><span class="p">,</span>
      <span class="s1">'bind'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="mi">101</span><span class="p">),</span>
      <span class="s1">'bindTypes'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="nx">PDO</span><span class="o">::</span><span class="na">PARAM_INT</span><span class="p">)</span> <span class="c1">//optional parameter</span>
   <span class="p">)</span>
<span class="p">);</span>

<span class="c1">// Deleting data with a raw SQL statement</span>
<span class="nv">$sql</span>     <span class="o">=</span> <span class="s2">"DELETE `robots` WHERE `id` = 101"</span><span class="p">;</span>
<span class="nv">$success</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>

<span class="c1">//With placeholders</span>
<span class="nv">$sql</span>     <span class="o">=</span> <span class="s2">"DELETE `robots` WHERE `id` = ?"</span><span class="p">;</span>
<span class="nv">$success</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="nv">$sql</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="mi">101</span><span class="p">));</span>

<span class="c1">// Generating dynamically the necessary SQL</span>
<span class="nv">$success</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">(</span><span class="s2">"robots"</span><span class="p">,</span> <span class="s2">"id = ?"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="mi">101</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="section" id="transactions-and-nested-transactions">
<h2>Transactions and Nested Transactions<a class="headerlink" href="db.html#transactions-and-nested-transactions" title="Permalink to this headline">¶</a>
</h2>
<p>Working with transactions is supported as it is with PDO. Perform data manipulation inside transactions
often increase the performance on most database systems:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">try</span> <span class="p">{</span>

    <span class="c1">//Start a transaction</span>
    <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">begin</span><span class="p">();</span>

    <span class="c1">//Execute some SQL statements</span>
    <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="s2">"DELETE `robots` WHERE `id` = 101"</span><span class="p">);</span>
    <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="s2">"DELETE `robots` WHERE `id` = 102"</span><span class="p">);</span>
    <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="s2">"DELETE `robots` WHERE `id` = 103"</span><span class="p">);</span>

    <span class="c1">//Commit if everything goes well</span>
    <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">commit</span><span class="p">();</span>

<span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//An exception has occurred rollback the transaction</span>
    <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">rollback</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In addition to standard transactions, Phalcon\Db provides built-in support for <a class="reference external" href="http://en.wikipedia.org/wiki/Nested_transaction">nested transactions</a>
(if the database system used supports them). When you call begin() for a second time a nested transaction
is created:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">try</span> <span class="p">{</span>

    <span class="c1">//Start a transaction</span>
    <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">begin</span><span class="p">();</span>

    <span class="c1">//Execute some SQL statements</span>
    <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="s2">"DELETE `robots` WHERE `id` = 101"</span><span class="p">);</span>

    <span class="k">try</span> <span class="p">{</span>

        <span class="c1">//Start a nested transaction</span>
        <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">begin</span><span class="p">();</span>

        <span class="c1">//Execute these SQL statements into the nested transaction</span>
        <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="s2">"DELETE `robots` WHERE `id` = 102"</span><span class="p">);</span>
        <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="s2">"DELETE `robots` WHERE `id` = 103"</span><span class="p">);</span>

        <span class="c1">//Create a save point</span>
        <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">commit</span><span class="p">();</span>

    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//An error has occurred, release the nested transaction</span>
        <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">rollback</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">//Continue, executing more SQL statements</span>
    <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="s2">"DELETE `robots` WHERE `id` = 104"</span><span class="p">);</span>

    <span class="c1">//Commit if everything goes well</span>
    <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">commit</span><span class="p">();</span>

<span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//An exception has occurred rollback the transaction</span>
    <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">rollback</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="database-events">
<h2>Database Events<a class="headerlink" href="db.html#database-events" title="Permalink to this headline">¶</a>
</h2>
<p><a class="reference internal" href="../api/Phalcon_Db.html"><em>Phalcon\Db</em></a> is able to send events to a <a class="reference internal" href="events.html"><em>EventsManager</em></a> if it’s present.
Some events when returning boolean false could stop the active operation. The following events are supported:</p>
<table border="1" class="docutils">
<colgroup>
<col width="21%">
<col width="59%">
<col width="0%">
<col width="20%">
</colgroup>
<thead valign="bottom">
<tr class="row-odd">
<th class="head">Event Name</th>
<th class="head">Triggered</th>
<th class="head" colspan="2">Can stop operation?</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even">
<td>afterConnect</td>
<td>After a successfully connection to a database system</td>
<td colspan="2">No</td>
</tr>
<tr class="row-odd">
<td>beforeQuery</td>
<td>Before send a SQL statement to the database system</td>
<td colspan="2">Yes</td>
</tr>
<tr class="row-even">
<td>afterQuery</td>
<td>After send a SQL statement to database system</td>
<td colspan="2">No</td>
</tr>
<tr class="row-odd">
<td>beforeDisconnect</td>
<td>Before close a temporal database connection</td>
<td colspan="2">No</td>
</tr>
<tr class="row-even">
<td>beginTransaction</td>
<td>Before a transaction is going to be started</td>
<td colspan="2">No</td>
</tr>
<tr class="row-odd">
<td>rollbackTransaction</td>
<td>Before a transaction is rollbacked</td>
<td colspan="2">No</td>
</tr>
<tr class="row-even">
<td>commitTransaction</td>
<td colspan="3">Before a transaction is committed                         | No</td>
</tr>
</tbody>
</table>
<p>Bind an EventsManager to a connection is simple, Phalcon\Db will trigger the events with the type “db”:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Events\Manager</span> <span class="k">as</span> <span class="nx">EventsManager</span><span class="p">,</span>
    <span class="nx">\Phalcon\Db\Adapter\Pdo\Mysql</span> <span class="k">as</span> <span class="nx">Connection</span><span class="p">;</span>

<span class="nv">$eventsManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventsManager</span><span class="p">();</span>

<span class="c1">//Listen all the database events</span>
<span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span><span class="s1">'db'</span><span class="p">,</span> <span class="nv">$dbListener</span><span class="p">);</span>

<span class="nv">$connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Connection</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s2">"host"</span> <span class="o">=&gt;</span> <span class="s2">"localhost"</span><span class="p">,</span>
    <span class="s2">"username"</span> <span class="o">=&gt;</span> <span class="s2">"root"</span><span class="p">,</span>
    <span class="s2">"password"</span> <span class="o">=&gt;</span> <span class="s2">"secret"</span><span class="p">,</span>
    <span class="s2">"dbname"</span> <span class="o">=&gt;</span> <span class="s2">"invo"</span>
<span class="p">));</span>

<span class="c1">//Assign the eventsManager to the db adapter instance</span>
<span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">setEventsManager</span><span class="p">(</span><span class="nv">$eventsManager</span><span class="p">);</span>
</pre></div>
</div>
<p>Stop SQL operations are very useful if for example you want to implement some last-resource SQL injector checker:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span><span class="s1">'db:beforeQuery'</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="nv">$event</span><span class="p">,</span> <span class="nv">$connection</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">//Check for malicious words in SQL statements</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/DROP|ALTER/i'</span><span class="p">,</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">getSQLStatement</span><span class="p">()))</span> <span class="p">{</span>
        <span class="c1">// DROP/ALTER operations aren't allowed in the application,</span>
        <span class="c1">// this must be a SQL injection!</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//It's ok</span>
    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
</div>
<div class="section" id="profiling-sql-statements">
<h2>Profiling SQL Statements<a class="headerlink" href="db.html#profiling-sql-statements" title="Permalink to this headline">¶</a>
</h2>
<p><a class="reference internal" href="../api/Phalcon_Db.html"><em>Phalcon\Db</em></a> includes a profiling component called <a class="reference internal" href="../api/Phalcon_Db_Profiler.html"><em>Phalcon\Db\Profiler</em></a>, that is used to analyze the performance of database operations so as to diagnose performance problems and discover bottlenecks.</p>
<p>Database profiling is really easy With <a class="reference internal" href="../api/Phalcon_Db_Profiler.html"><em>Phalcon\Db\Profiler</em></a>:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Events\Manager</span> <span class="k">as</span> <span class="nx">EventsManager</span><span class="p">,</span>
    <span class="nx">Phalcon\Db\Profiler</span> <span class="k">as</span> <span class="nx">DbProfiler</span><span class="p">;</span>

<span class="nv">$eventsManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventsManager</span><span class="p">();</span>

<span class="nv">$profiler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DbProfiler</span><span class="p">();</span>

<span class="c1">//Listen all the database events</span>
<span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span><span class="s1">'db'</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="nv">$event</span><span class="p">,</span> <span class="nv">$connection</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$profiler</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getType</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'beforeQuery'</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//Start a profile with the active connection</span>
        <span class="nv">$profiler</span><span class="o">-&gt;</span><span class="na">startProfile</span><span class="p">(</span><span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">getSQLStatement</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getType</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'afterQuery'</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//Stop the active profile</span>
        <span class="nv">$profiler</span><span class="o">-&gt;</span><span class="na">stopProfile</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="c1">//Assign the events manager to the connection</span>
<span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">setEventsManager</span><span class="p">(</span><span class="nv">$eventsManager</span><span class="p">);</span>

<span class="nv">$sql</span> <span class="o">=</span> <span class="s2">"SELECT buyer_name, quantity, product_name "</span>
     <span class="o">.</span> <span class="s2">"FROM buyers "</span>
     <span class="o">.</span> <span class="s2">"LEFT JOIN products ON buyers.pid = products.id"</span><span class="p">;</span>

<span class="c1">// Execute a SQL statement</span>
<span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>

<span class="c1">// Get the last profile in the profiler</span>
<span class="nv">$profile</span> <span class="o">=</span> <span class="nv">$profiler</span><span class="o">-&gt;</span><span class="na">getLastProfile</span><span class="p">();</span>

<span class="k">echo</span> <span class="s2">"SQL Statement: "</span><span class="p">,</span> <span class="nv">$profile</span><span class="o">-&gt;</span><span class="na">getSQLStatement</span><span class="p">(),</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">"Start Time: "</span><span class="p">,</span> <span class="nv">$profile</span><span class="o">-&gt;</span><span class="na">getInitialTime</span><span class="p">(),</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">"Final Time: "</span><span class="p">,</span> <span class="nv">$profile</span><span class="o">-&gt;</span><span class="na">getFinalTime</span><span class="p">(),</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="k">echo</span> <span class="s2">"Total Elapsed Time: "</span><span class="p">,</span> <span class="nv">$profile</span><span class="o">-&gt;</span><span class="na">getTotalElapsedSeconds</span><span class="p">(),</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
</pre></div>
</div>
<p>You can also create your own profile class based on <a class="reference internal" href="../api/Phalcon_Db_Profiler.html"><em>Phalcon\Db\Profiler</em></a> to record real time statistics of the statements sent to the database system:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Events\Manager</span> <span class="k">as</span> <span class="nx">EventsManager</span><span class="p">,</span>
    <span class="nx">Phalcon\Db\Profiler</span> <span class="k">as</span> <span class="nx">Profiler</span><span class="p">,</span>
    <span class="nx">Phalcon\Db\Profiler\Item</span> <span class="k">as</span> <span class="nx">Item</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">DbProfiler</span> <span class="k">extends</span> <span class="nx">Profiler</span>
<span class="p">{</span>

    <span class="sd">/**</span>
<span class="sd">     * Executed before the SQL statement will sent to the db server</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">beforeStartProfile</span><span class="p">(</span><span class="nx">Item</span> <span class="nv">$profile</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="nv">$profile</span><span class="o">-&gt;</span><span class="na">getSQLStatement</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Executed after the SQL statement was sent to the db server</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">afterEndProfile</span><span class="p">(</span><span class="nx">Item</span> <span class="nv">$profile</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="nv">$profile</span><span class="o">-&gt;</span><span class="na">getTotalElapsedSeconds</span><span class="p">();</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="c1">//Create an EventsManager</span>
<span class="nv">$eventsManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventsManager</span><span class="p">();</span>

<span class="c1">//Create a listener</span>
<span class="nv">$dbProfiler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DbProfiler</span><span class="p">();</span>

<span class="c1">//Attach the listener listening for all database events</span>
<span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span><span class="s1">'db'</span><span class="p">,</span> <span class="nv">$dbProfiler</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="logging-sql-statements">
<h2>Logging SQL Statements<a class="headerlink" href="db.html#logging-sql-statements" title="Permalink to this headline">¶</a>
</h2>
<p>Using high-level abstraction components such as <a class="reference internal" href="../api/Phalcon_Db.html"><em>Phalcon\Db</em></a> to access a database, it is difficult to understand which statements are sent to the database system. <a class="reference internal" href="../api/Phalcon_Logger.html"><em>Phalcon\Logger</em></a> interacts with <a class="reference internal" href="../api/Phalcon_Db.html"><em>Phalcon\Db</em></a>, providing logging capabilities on the database abstraction layer.</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Logger</span><span class="p">,</span>
    <span class="nx">Phalcon\Events\Manager</span> <span class="k">as</span> <span class="nx">EventsManager</span><span class="p">,</span>
    <span class="nx">Phalcon\Logger\Adapter\File</span> <span class="k">as</span> <span class="nx">FileLogger</span><span class="p">;</span>

<span class="nv">$eventsManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventsManager</span><span class="p">();</span>

<span class="nv">$logger</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileLogger</span><span class="p">(</span><span class="s2">"app/logs/db.log"</span><span class="p">);</span>

<span class="c1">//Listen all the database events</span>
<span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span><span class="s1">'db'</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="nv">$event</span><span class="p">,</span> <span class="nv">$connection</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$logger</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getType</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'beforeQuery'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$logger</span><span class="o">-&gt;</span><span class="na">log</span><span class="p">(</span><span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">getSQLStatement</span><span class="p">(),</span> <span class="nx">Logger</span><span class="o">::</span><span class="na">INFO</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="c1">//Assign the eventsManager to the db adapter instance</span>
<span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">setEventsManager</span><span class="p">(</span><span class="nv">$eventsManager</span><span class="p">);</span>

<span class="c1">//Execute some SQL statement</span>
<span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span>
    <span class="s2">"products"</span><span class="p">,</span>
    <span class="k">array</span><span class="p">(</span><span class="s2">"Hot pepper"</span><span class="p">,</span> <span class="mf">3.50</span><span class="p">),</span>
    <span class="k">array</span><span class="p">(</span><span class="s2">"name"</span><span class="p">,</span> <span class="s2">"price"</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
<p>As above, the file <em>app/logs/db.log</em> will contain something like this:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="x">[Sun, 29 Apr 12 22:35:26 -0500][DEBUG][Resource Id #77] INSERT INTO products</span>
<span class="x">(name, price) VALUES ('Hot pepper', 3.50)</span>
</pre></div>
</div>
<div class="section" id="implementing-your-own-logger">
<h3>Implementing your own Logger<a class="headerlink" href="db.html#implementing-your-own-logger" title="Permalink to this headline">¶</a>
</h3>
<p>You can implement your own logger class for database queries, by creating a class that implements a single method called “log”.
The method needs to accept a string as the first argument. You can then pass your logging object to Phalcon\Db::setLogger(),
and from then on any SQL statement executed will call that method to log the results.</p>
</div>
</div>
<div class="section" id="describing-tables-views">
<h2>Describing Tables/Views<a class="headerlink" href="db.html#describing-tables-views" title="Permalink to this headline">¶</a>
</h2>
<p><a class="reference internal" href="../api/Phalcon_Db.html"><em>Phalcon\Db</em></a> also provides methods to retrieve detailed information about tables and views:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Get tables on the test_db database</span>
<span class="nv">$tables</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">listTables</span><span class="p">(</span><span class="s2">"test_db"</span><span class="p">);</span>

<span class="c1">// Is there a table 'robots' in the database?</span>
<span class="nv">$exists</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">tableExists</span><span class="p">(</span><span class="s2">"robots"</span><span class="p">);</span>

<span class="c1">// Get name, data types and special features of 'robots' fields</span>
<span class="nv">$fields</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">describeColumns</span><span class="p">(</span><span class="s2">"robots"</span><span class="p">);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$fields</span> <span class="k">as</span> <span class="nv">$field</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"Column Type: "</span><span class="p">,</span> <span class="nv">$field</span><span class="p">[</span><span class="s2">"Type"</span><span class="p">];</span>
<span class="p">}</span>

<span class="c1">// Get indexes on the 'robots' table</span>
<span class="nv">$indexes</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">describeIndexes</span><span class="p">(</span><span class="s2">"robots"</span><span class="p">);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$indexes</span> <span class="k">as</span> <span class="nv">$index</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">print_r</span><span class="p">(</span><span class="nv">$index</span><span class="o">-&gt;</span><span class="na">getColumns</span><span class="p">());</span>
<span class="p">}</span>

<span class="c1">// Get foreign keys on the 'robots' table</span>
<span class="nv">$references</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">describeReferences</span><span class="p">(</span><span class="s2">"robots"</span><span class="p">);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$references</span> <span class="k">as</span> <span class="nv">$reference</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Print referenced columns</span>
    <span class="nb">print_r</span><span class="p">(</span><span class="nv">$reference</span><span class="o">-&gt;</span><span class="na">getReferencedColumns</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A table description is very similar to the MySQL describe command, it contains the following information:</p>
<table border="1" class="docutils">
<colgroup>
<col width="12%">
<col width="88%">
</colgroup>
<thead valign="bottom">
<tr class="row-odd">
<th class="head">Index</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even">
<td>Field</td>
<td>Field’s name</td>
</tr>
<tr class="row-odd">
<td>Type</td>
<td>Column Type</td>
</tr>
<tr class="row-even">
<td>Key</td>
<td>Is the column part of the primary key or an index?</td>
</tr>
<tr class="row-odd">
<td>Null</td>
<td>Does the column allow null values?</td>
</tr>
</tbody>
</table>
<p>Methods to get information about views are also implemented for every supported database system:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Get views on the test_db database</span>
<span class="nv">$tables</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">listViews</span><span class="p">(</span><span class="s2">"test_db"</span><span class="p">);</span>

<span class="c1">// Is there a view 'robots' in the database?</span>
<span class="nv">$exists</span> <span class="o">=</span> <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">viewExists</span><span class="p">(</span><span class="s2">"robots"</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-altering-dropping-tables">
<h2>Creating/Altering/Dropping Tables<a class="headerlink" href="db.html#creating-altering-dropping-tables" title="Permalink to this headline">¶</a>
</h2>
<p>Different database systems (MySQL, Postgresql etc.) offer the ability to create, alter or drop tables with the use of
commands such as CREATE, ALTER or DROP. The SQL syntax differs based on which database system is used.
<a class="reference internal" href="../api/Phalcon_Db.html"><em>Phalcon\Db</em></a> offers a unified interface to alter tables, without the need to
differentiate the SQL syntax based on the target storage system.</p>
<div class="section" id="creating-tables">
<h3>Creating Tables<a class="headerlink" href="db.html#creating-tables" title="Permalink to this headline">¶</a>
</h3>
<p>The following example shows how to create a table:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">\Phalcon\Db\Column</span> <span class="k">as</span> <span class="nx">Column</span><span class="p">;</span>

<span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">createTable</span><span class="p">(</span>
    <span class="s2">"robots"</span><span class="p">,</span>
    <span class="k">null</span><span class="p">,</span>
    <span class="k">array</span><span class="p">(</span>
       <span class="s2">"columns"</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="k">new</span> <span class="nx">Column</span><span class="p">(</span><span class="s2">"id"</span><span class="p">,</span>
                <span class="k">array</span><span class="p">(</span>
                    <span class="s2">"type"</span>          <span class="o">=&gt;</span> <span class="nx">Column</span><span class="o">::</span><span class="na">TYPE_INTEGER</span><span class="p">,</span>
                    <span class="s2">"size"</span>          <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">,</span>
                    <span class="s2">"notNull"</span>       <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
                    <span class="s2">"autoIncrement"</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">),</span>
            <span class="k">new</span> <span class="nx">Column</span><span class="p">(</span><span class="s2">"name"</span><span class="p">,</span>
                <span class="k">array</span><span class="p">(</span>
                    <span class="s2">"type"</span>    <span class="o">=&gt;</span> <span class="nx">Column</span><span class="o">::</span><span class="na">TYPE_VARCHAR</span><span class="p">,</span>
                    <span class="s2">"size"</span>    <span class="o">=&gt;</span> <span class="mi">70</span><span class="p">,</span>
                    <span class="s2">"notNull"</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">),</span>
            <span class="k">new</span> <span class="nx">Column</span><span class="p">(</span><span class="s2">"year"</span><span class="p">,</span>
                <span class="k">array</span><span class="p">(</span>
                    <span class="s2">"type"</span>    <span class="o">=&gt;</span> <span class="nx">Column</span><span class="o">::</span><span class="na">TYPE_INTEGER</span><span class="p">,</span>
                    <span class="s2">"size"</span>    <span class="o">=&gt;</span> <span class="mi">11</span><span class="p">,</span>
                    <span class="s2">"notNull"</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
<p>Phalcon\Db::createTable() accepts an associative array describing the table. Columns are defined with the class
<a class="reference internal" href="../api/Phalcon_Db_Column.html"><em>Phalcon\Db\Column</em></a>. The table below shows the options available to define a column:</p>
<table border="1" class="docutils">
<colgroup>
<col width="10%">
<col width="84%">
<col width="6%">
</colgroup>
<thead valign="bottom">
<tr class="row-odd">
<th class="head">Option</th>
<th class="head">Description</th>
<th class="head">Optional</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even">
<td>“type”</td>
<td>Column type. Must be a Phalcon\Db\Column constant (see below for a list)</td>
<td>No</td>
</tr>
<tr class="row-odd">
<td>“primary”</td>
<td>True if the column is part of the table’s primary</td>
<td>Yes</td>
</tr>
<tr class="row-even">
<td>“size”</td>
<td>Some type of columns like VARCHAR or INTEGER may have a specific size</td>
<td>Yes</td>
</tr>
<tr class="row-odd">
<td>“scale”</td>
<td>DECIMAL or NUMBER columns may be have a scale to specify how many decimals should be stored</td>
<td>Yes</td>
</tr>
<tr class="row-even">
<td>“unsigned”</td>
<td>INTEGER columns may be signed or unsigned. This option does not apply to other types of columns</td>
<td>Yes</td>
</tr>
<tr class="row-odd">
<td>“notNull”</td>
<td>Column can store null values?</td>
<td>Yes</td>
</tr>
<tr class="row-even">
<td>“autoIncrement”</td>
<td>With this attribute column will filled automatically with an auto-increment integer. Only one column in the table can have this attribute.</td>
<td>Yes</td>
</tr>
<tr class="row-odd">
<td>“bind”</td>
<td>One of the BIND_TYPE_* constants telling how the column must be binded before save it</td>
<td>Yes</td>
</tr>
<tr class="row-even">
<td>“first”</td>
<td>Column must be placed at first position in the column order</td>
<td>Yes</td>
</tr>
<tr class="row-odd">
<td>“after”</td>
<td>Column must be placed after indicated column</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<p>Phalcon\Db supports the following database column types:</p>
<ul class="simple">
<li>Phalcon\Db\Column::TYPE_INTEGER</li>
<li>Phalcon\Db\Column::TYPE_DATE</li>
<li>Phalcon\Db\Column::TYPE_VARCHAR</li>
<li>Phalcon\Db\Column::TYPE_DECIMAL</li>
<li>Phalcon\Db\Column::TYPE_DATETIME</li>
<li>Phalcon\Db\Column::TYPE_CHAR</li>
<li>Phalcon\Db\Column::TYPE_TEXT</li>
</ul>
<p>The associative array passed in Phalcon\Db::createTable() can have the possible keys:</p>
<table border="1" class="docutils">
<colgroup>
<col width="9%">
<col width="85%">
<col width="6%">
</colgroup>
<thead valign="bottom">
<tr class="row-odd">
<th class="head">Index</th>
<th class="head">Description</th>
<th class="head">Optional</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even">
<td>“columns”</td>
<td>An array with a set of table columns defined with <a class="reference internal" href="../api/Phalcon_Db_Column.html"><em>Phalcon\Db\Column</em></a>
</td>
<td>No</td>
</tr>
<tr class="row-odd">
<td>“indexes”</td>
<td>An array with a set of table indexes defined with <a class="reference internal" href="../api/Phalcon_Db_Index.html"><em>Phalcon\Db\Index</em></a>
</td>
<td>Yes</td>
</tr>
<tr class="row-even">
<td>“references”</td>
<td>An array with a set of table references (foreign keys) defined with <a class="reference internal" href="../api/Phalcon_Db_Reference.html"><em>Phalcon\Db\Reference</em></a>
</td>
<td>Yes</td>
</tr>
<tr class="row-odd">
<td>“options”</td>
<td>An array with a set of table creation options. These options often relate to the database system in which the migration was generated.</td>
<td>Yes</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="altering-tables">
<h3>Altering Tables<a class="headerlink" href="db.html#altering-tables" title="Permalink to this headline">¶</a>
</h3>
<p>As your application grows, you might need to alter your database, as part of a refactoring or adding new features.
Not all database systems allow to modify existing columns or add columns between two existing ones. <a class="reference internal" href="../api/Phalcon_Db.html"><em>Phalcon\Db</em></a>
is limited by these constraints.</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Db\Column</span> <span class="k">as</span> <span class="nx">Column</span><span class="p">;</span>

<span class="c1">// Adding a new column</span>
<span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">addColumn</span><span class="p">(</span><span class="s2">"robots"</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span>
    <span class="k">new</span> <span class="nx">Column</span><span class="p">(</span><span class="s2">"robot_type"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
        <span class="s2">"type"</span>    <span class="o">=&gt;</span> <span class="nx">Column</span><span class="o">::</span><span class="na">TYPE_VARCHAR</span><span class="p">,</span>
        <span class="s2">"size"</span>    <span class="o">=&gt;</span> <span class="mi">32</span><span class="p">,</span>
        <span class="s2">"notNull"</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
        <span class="s2">"after"</span>   <span class="o">=&gt;</span> <span class="s2">"name"</span>
    <span class="p">))</span>
<span class="p">);</span>

<span class="c1">// Modifying an existing column</span>
<span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">modifyColumn</span><span class="p">(</span><span class="s2">"robots"</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Column</span><span class="p">(</span><span class="s2">"name"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s2">"type"</span> <span class="o">=&gt;</span> <span class="nx">Column</span><span class="o">::</span><span class="na">TYPE_VARCHAR</span><span class="p">,</span>
    <span class="s2">"size"</span> <span class="o">=&gt;</span> <span class="mi">40</span><span class="p">,</span>
    <span class="s2">"notNull"</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
<span class="p">)));</span>

<span class="c1">// Deleting the column "name"</span>
<span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">dropColumn</span><span class="p">(</span><span class="s2">"robots"</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="dropping-tables">
<h3>Dropping Tables<a class="headerlink" href="db.html#dropping-tables" title="Permalink to this headline">¶</a>
</h3>
<p>Examples on dropping tables:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Drop table robot from active database</span>
<span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">dropTable</span><span class="p">(</span><span class="s2">"robots"</span><span class="p">);</span>

<span class="c1">//Drop table robot from database "machines"</span>
<span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">dropTable</span><span class="p">(</span><span class="s2">"robots"</span><span class="p">,</span> <span class="s2">"machines"</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
</div>


                    </div>
                  </div>
                </div>
            </div>
          </td>
        </tr>
      </table>
    

      


    
    

  </body>
</html>
