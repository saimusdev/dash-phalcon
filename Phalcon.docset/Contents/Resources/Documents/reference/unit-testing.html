
<!DOCTYPE html>
<html lang="en">
<head><script type="text/javascript">var _gaq=_gaq||[];_gaq.push(['_setSiteSpeedSampleRate',100]);</script>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>Unit testing &mdash; Phalcon 1.3.0 documentation</title>
<link href='http://fonts.googleapis.com/css?family=Ubuntu:400,500,700,300italic,400italic,500italic&amp;subset=latin,cyrillic-ext' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="../_static/A.pygments.css+style.css+docs.css,Mcc.WzpOlAvwWN.css.pagespeed.cf.Utjfc6NUWU.css" type="text/css"/>
<script type="text/javascript">var DOCUMENTATION_OPTIONS={URL_ROOT:'../',VERSION:'1.3.0',COLLAPSE_MODINDEX:false,FILE_SUFFIX:'.html',HAS_SOURCE:true};</script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
<script type="text/javascript" src="../_static/docs.js.pagespeed.jm.73YAAA_a6c.js"></script>
<link rel="shortcut icon" href="../_static/favicon.ico"/>
<link rel="top" title="Phalcon 1.3.0 documentation" href="../index.html"/>
<link rel="next" title="API Indice" href="../api/index.html"/>
<link rel="prev" title="Increasing Performance: What’s next?" href="whats-next.html"/>
</head>
<body>
<div id="wrapper">



<table width="100%" align="center">
<tr>

<td class="second-box" valign="top">
<div class="document">
<div class="documentwrapper">
<div class="bodywrapper">
<div class="body">
<div class="section" id="unit-testing">
<h1>Unit testing<a class="headerlink" href="unit-testing.html#unit-testing" title="Permalink to this headline">¶</a></h1>
<p>Writing proper tests can assist in writing better software. If you set up proper test cases you can eliminate most
functional bugs and better maintain your software.</p>
<div class="section" id="integrating-phpunit-with-phalcon">
<h2>Integrating PHPunit with phalcon<a class="headerlink" href="unit-testing.html#integrating-phpunit-with-phalcon" title="Permalink to this headline">¶</a></h2>
<p>If you don&#8217;t already have phpunit installed, you can do it by using the following composer command:</p>
<div class="highlight-bash"><div class="highlight"><pre>composer require phpunit/phpunit
</pre></div>
</div>
<p>or by manually adding it to composer.json:</p>
<div class="highlight-json"><div class="highlight"><pre><span class="p">{</span>
    <span class="nt">&quot;require-dev&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;phpunit/phpunit&quot;</span><span class="p">:</span> <span class="s2">&quot;3.7.*&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Or if you don&#8217;t have composer you can install phpunit via pear:</p>
<div class="highlight-bash"><div class="highlight"><pre>pear config-set auto_discover 1
pear install pear.phpunit.de/PHPUnit
</pre></div>
</div>
<p>Once phpunit is installed create a directory called &#8216;tests&#8217; in your root directory:</p>
<div class="highlight-bash"><div class="highlight"><pre>app/
public/
tests/
</pre></div>
</div>
<p>Next, we need a &#8216;helper&#8217; file to bootstrap the application for unit testing.</p>
</div>
<div class="section" id="the-phpunit-helper-file">
<h2>The PHPunit helper file<a class="headerlink" href="unit-testing.html#the-phpunit-helper-file" title="Permalink to this headline">¶</a></h2>
<p>A helper file is required to bootstrap the application for running the tests. We have prepared a sample file. Put the
file in your tests/ directory as TestHelper.php.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">use</span> <span class="nx">Phalcon\DI</span><span class="p">,</span>
    <span class="nx">Phalcon\DI\FactoryDefault</span><span class="p">;</span>

<span class="nb">ini_set</span><span class="p">(</span><span class="s1">&#39;display_errors&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="nb">error_reporting</span><span class="p">(</span><span class="k">E_ALL</span><span class="p">);</span>

<span class="nb">define</span><span class="p">(</span><span class="s1">&#39;ROOT_PATH&#39;</span><span class="p">,</span> <span class="nx">__DIR__</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">&#39;PATH_LIBRARY&#39;</span><span class="p">,</span> <span class="nx">__DIR__</span> <span class="o">.</span> <span class="s1">&#39;/../app/library/&#39;</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">&#39;PATH_SERVICES&#39;</span><span class="p">,</span> <span class="nx">__DIR__</span> <span class="o">.</span> <span class="s1">&#39;/../app/services/&#39;</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">&#39;PATH_RESOURCES&#39;</span><span class="p">,</span> <span class="nx">__DIR__</span> <span class="o">.</span> <span class="s1">&#39;/../app/resources/&#39;</span><span class="p">);</span>

<span class="nb">set_include_path</span><span class="p">(</span>
    <span class="nx">ROOT_PATH</span> <span class="o">.</span> <span class="nx">PATH_SEPARATOR</span> <span class="o">.</span> <span class="nb">get_include_path</span><span class="p">()</span>
<span class="p">);</span>

<span class="c1">// required for phalcon/incubator</span>
<span class="k">include</span> <span class="nx">__DIR__</span> <span class="o">.</span> <span class="s2">&quot;/../vendor/autoload.php&quot;</span><span class="p">;</span>

<span class="c1">// use the application autoloader to autoload the classes</span>
<span class="c1">// autoload the dependencies found in composer</span>
<span class="nv">$loader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Phalcon\Loader</span><span class="p">();</span>

<span class="nv">$loader</span><span class="o">-&gt;</span><span class="na">registerDirs</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="nx">ROOT_PATH</span>
<span class="p">));</span>

<span class="nv">$loader</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">();</span>

<span class="nv">$di</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FactoryDefault</span><span class="p">();</span>
<span class="nx">DI</span><span class="o">::</span><span class="na">reset</span><span class="p">();</span>

<span class="c1">// add any needed services to the DI here</span>

<span class="nx">DI</span><span class="o">::</span><span class="na">setDefault</span><span class="p">(</span><span class="nv">$di</span><span class="p">);</span>
</pre></div>
</div>
<p>Should you need to test any components from your own library, add them to the autoloader or use the autoloader from your
main application.</p>
<p>To help you build the unit tests, we made a few abstract classes you can use to bootstrap the unit tests themselves.
These files exist in the Phalcon incubator &#64; <a class="reference external" href="https://github.com/phalcon/incubator">https://github.com/phalcon/incubator</a>.</p>
<p>You can use the incubator library by adding it as a dependency:</p>
<div class="highlight-bash"><div class="highlight"><pre>composer require phalcon/incubator
</pre></div>
</div>
<p>or by manually adding it to composer.json:</p>
<div class="highlight-json"><div class="highlight"><pre><span class="p">{</span>
    <span class="nt">&quot;require&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;phalcon/incubator&quot;</span><span class="p">:</span> <span class="s2">&quot;dev-master&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can also clone the repository using the repo link above.</p>
</div>
<div class="section" id="phpunit-xml-file">
<h2>PHPunit.xml file<a class="headerlink" href="unit-testing.html#phpunit-xml-file" title="Permalink to this headline">¶</a></h2>
<p>Now, create a phpunit file:</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;phpunit</span> <span class="na">bootstrap=</span><span class="s">&quot;./TestHelper.php&quot;</span>
         <span class="na">backupGlobals=</span><span class="s">&quot;false&quot;</span>
         <span class="na">backupStaticAttributes=</span><span class="s">&quot;false&quot;</span>
         <span class="na">verbose=</span><span class="s">&quot;true&quot;</span>
         <span class="na">colors=</span><span class="s">&quot;false&quot;</span>
         <span class="na">convertErrorsToExceptions=</span><span class="s">&quot;true&quot;</span>
         <span class="na">convertNoticesToExceptions=</span><span class="s">&quot;true&quot;</span>
         <span class="na">convertWarningsToExceptions=</span><span class="s">&quot;true&quot;</span>
         <span class="na">processIsolation=</span><span class="s">&quot;false&quot;</span>
         <span class="na">stopOnFailure=</span><span class="s">&quot;false&quot;</span>
         <span class="na">syntaxCheck=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;testsuite</span> <span class="na">name=</span><span class="s">&quot;Phalcon - Testsuite&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;directory&gt;</span>./<span class="nt">&lt;/directory&gt;</span>
    <span class="nt">&lt;/testsuite&gt;</span>
<span class="nt">&lt;/phpunit&gt;</span>
</pre></div>
</div>
<p>Modify the phpunit.xml to fit your needs and save it in tests/.</p>
<p>This will run any tests under the tests/ directory.</p>
</div>
<div class="section" id="sample-unit-test">
<h2>Sample unit test<a class="headerlink" href="unit-testing.html#sample-unit-test" title="Permalink to this headline">¶</a></h2>
<p>To run any unit tests you need to define them. The autoloader will make sure the proper files are loaded so all you
need to do is create the files and phpunit will run the tests for you.</p>
<p>This example does not contain a config file, most test cases however, do need one. You can add it to the DI to get the UnitTestCase file.</p>
<p>First create a base unit test called UnitTestCase.php in your /tests directory:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">use</span> <span class="nx">Phalcon\DI</span><span class="p">,</span>
    <span class="nx">\Phalcon\Test\UnitTestCase</span> <span class="k">as</span> <span class="nx">PhalconTestCase</span><span class="p">;</span>

<span class="k">abstract</span> <span class="k">class</span> <span class="nc">UnitTestCase</span> <span class="k">extends</span> <span class="nx">PhalconTestCase</span> <span class="p">{</span>

    <span class="sd">/**</span>
<span class="sd">     * @var \Voice\Cache</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$_cache</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var \Phalcon\Config</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$_config</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var bool</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$_loaded</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setUp</span><span class="p">(</span><span class="nx">Phalcon\DiInterface</span> <span class="nv">$di</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">,</span> <span class="nx">Phalcon\Config</span> <span class="nv">$config</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Load any additional services that might be required during testing</span>
        <span class="nv">$di</span> <span class="o">=</span> <span class="nx">DI</span><span class="o">::</span><span class="na">getDefault</span><span class="p">();</span>

        <span class="c1">// get any DI components here. If you have a config, be sure to pass it to the parent</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">setUp</span><span class="p">(</span><span class="nv">$di</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_loaded</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Check if the test case is setup properly</span>
<span class="sd">     * @throws \PHPUnit_Framework_IncompleteTestError;</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__destruct</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_loaded</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\PHPUnit_Framework_IncompleteTestError</span><span class="p">(</span><span class="s1">&#39;Please run parent::setUp().&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It&#8217;s always a good idea to separate your Unit tests in namespaces. For this test we will create the namespace
&#8216;Test&#8217;. So create a file called testsTestUnitTest.php:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Test</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * Class UnitTest</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">UnitTest</span> <span class="k">extends</span> <span class="nx">\UnitTestCase</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testTestCase</span><span class="p">()</span> <span class="p">{</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s1">&#39;works&#39;</span><span class="p">,</span>
            <span class="s1">&#39;works&#39;</span><span class="p">,</span>
            <span class="s1">&#39;This is OK&#39;</span>
        <span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s1">&#39;works&#39;</span><span class="p">,</span>
            <span class="s1">&#39;works1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;This wil fail&#39;</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now when you execute &#8216;phpunit&#8217; in your command-line from the tests directory you will get the following output:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>phpunit
PHPUnit 3.7.23 by Sebastian Bergmann.

Configuration <span class="nb">read </span>from /private/var/www/tests/phpunit.xml

Time: 3 ms, Memory: 3.25Mb

There was 1 failure:

1<span class="o">)</span> Test<span class="se">\U</span>nitTest::testTestCase
This wil fail
Failed asserting that two strings are equal.
--- Expected
+++ Actual
@@ @@
-<span class="s1">&#39;works&#39;</span>
+<span class="s1">&#39;works1&#39;</span>

/private/var/www/tests/Test/UnitTest.php:25

FAILURES!
Tests: 1, Assertions: 2, Failures: 1.
</pre></div>
</div>
<p>Now you can start building your unit tests. You can view a good guide here (we also recommend reading the
PHPunit documentation if you&#8217;re not familiar with PHPunit):</p>
<p><a class="reference external" href="http://blog.stevensanderson.com/2009/08/24/writing-great-unit-tests-best-and-worst-practises/">http://blog.stevensanderson.com/2009/08/24/writing-great-unit-tests-best-and-worst-practises/</a></p>
</div>
</div>
</div>
</div>
</div>
</div>
</td>
</tr>
</table>
<div class="related">
<ul>
<li class="right">
<a href="../genindex.html" title="General Index">index</a></li>
<li class="right">
<a href="../api/index.html" title="API Indice">next</a> |</li>
<li class="right">
<a href="whats-next.html" title="Increasing Performance: What’s next?">previous</a> |</li>
</ul>
</div>

</div>
<script type="text/javascript">$(window).on("load",function(){var cx='009733439235723428699:lh9ltjgvdz8';var gcse=document.createElement('script');gcse.type='text/javascript';gcse.async=true;gcse.src=(document.location.protocol=='https:'?'https:':'http:')+'//www.google.com/cse/cse.js?cx='+cx;var s=document.getElementsByTagName('script')[0];s.parentNode.insertBefore(gcse,s);});</script>
<script pagespeed_no_defer="">//<![CDATA[
(function(){var e=encodeURIComponent,f=window,h=document,m="width",n="documentElement",p="height",q="length",r="prototype",s="body",t="&",u="&ci=",w="&n=",x="&rd=",y=",",z="?",A="Content-Type",B="Microsoft.XMLHTTP",C="Msxml2.XMLHTTP",D="POST",E="application/x-www-form-urlencoded",F="img",G="input",H="load",I="oh=",J="on",K="pagespeed_url_hash",L="url=",M=function(a,c,d){if(a.addEventListener)a.addEventListener(c,d,!1);else if(a.attachEvent)a.attachEvent(J+c,d);else{var b=a[J+c];a[J+c]=function(){d.call(this);b&&b.call(this)}}};f.pagespeed=f.pagespeed||{};var N=f.pagespeed,O=function(a,c,d,b,g){this.d=a;this.f=c;this.g=d;this.a=g;this.c={height:f.innerHeight||h[n].clientHeight||h[s].clientHeight,width:f.innerWidth||h[n].clientWidth||h[s].clientWidth};this.e=b;this.b={}};O[r].j=function(a){a=a.getBoundingClientRect();return{top:a.top+(void 0!==f.pageYOffset?f.pageYOffset:(h[n]||h[s].parentNode||h[s]).scrollTop),left:a.left+(void 0!==f.pageXOffset?f.pageXOffset:(h[n]||h[s].parentNode||h[s]).scrollLeft)}};O[r].i=function(a){if(0>=a.offsetWidth&&0>=a.offsetHeight)return!1;a=this.j(a);var c=a.top.toString()+y+a.left.toString();if(this.b.hasOwnProperty(c))return!1;this.b[c]=!0;return a.top<=this.c[p]&&a.left<=this.c[m]};O[r].l=function(){for(var a=[F,G],c=[],d={},b=0;b<a[q];++b)for(var g=h.getElementsByTagName(a[b]),k=0;k<g[q];++k){var v=g[k].getAttribute(K);v&&g[k].getBoundingClientRect&&this.i(g[k])&&!(v in d)&&(c.push(v),d[v]=!0)}b=!1;a=I+this.g;this.a&&(a+=w+this.a);if(0!=c[q]){a+=u+e(c[0]);for(b=1;b<c[q];++b){d=y+e(c[b]);if(131072<a[q]+d[q])break;a+=d}b=!0}this.e&&(d=x+e(JSON.stringify(this.h())),131072>=a[q]+d[q]&&(a+=d),b=!0);N.criticalImagesBeaconData=a;if(b){var c=this.d,b=this.f,l;if(f.XMLHttpRequest)l=new XMLHttpRequest;else if(f.ActiveXObject)try{l=new ActiveXObject(C)}catch(P){try{l=new ActiveXObject(B)}catch(Q){}}l&&(l.open(D,c+(-1==c.indexOf(z)?z:t)+L+e(b)),l.setRequestHeader(A,E),l.send(a))}};O[r].h=function(){for(var a={},c=h.getElementsByTagName(F),d=0;d<c[q];++d){var b=c[d],g=b.getAttribute(K);if("undefined"==typeof b.naturalWidth||"undefined"==typeof b.naturalHeight||"undefined"==typeof g)break;if("undefined"==typeof a[b.src]&&0<b[m]&&0<b[p]&&0<b.naturalWidth&&0<b.naturalHeight||"undefined"!=typeof a[b.src]&&b[m]>=a[b.src].n&&b[p]>=a[b.src].m)a[g]={renderedWidth:b[m],renderedHeight:b[p],originalWidth:b.naturalWidth,originalHeight:b.naturalHeight}}return a};N.k=function(a,c,d,b,g){var k=new O(a,c,d,b,g);M(f,H,function(){f.setTimeout(function(){k.l()},0)})};N.criticalImagesBeaconInit=N.k;})();pagespeed.criticalImagesBeaconInit('/mod_pagespeed_beacon','http://docs.phalconphp.com/en/latest/reference/unit-testing.html','YzCdeUYw1v',false,'vTmA00peGj4');
//]]></script><script type="text/javascript">if(window.parent==window){var _gaq=_gaq||[];_gaq.push(['_setAccount','UA-29332509-1']);_gaq.push(['_setDomainName','docs.phalconphp.com']);_gaq.push(['_setAllowLinker',true]);_gaq.push(['_trackPageview']);(function(){var ga=document.createElement('script');ga.type='text/javascript';ga.async=true;ga.src='http://www.google-analytics.com/ga.js';var s=document.getElementsByTagName('script')[0];s.parentNode.insertBefore(ga,s);})();}</script></body>
</html>