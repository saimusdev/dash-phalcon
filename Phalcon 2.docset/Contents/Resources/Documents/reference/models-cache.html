<!DOCTYPE html>
<html lang="en">
  <head>
    
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    
    <title>Caching in the ORM — Phalcon 2.0.0 documentation</title>
    <meta name="keywords" content="php, phalcon, phalcon php, php framework, faster php framework">
<link rel="stylesheet" type="text/css" href="http://netdna.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="http://static.phalconphp.com/css/phalcon.min.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:700,400" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Merriweather:400,700" rel="stylesheet" type="text/css">
    <!--
    EUROPE <link href='https://fonts.googleapis.com/css?family=Open+Sans:700,400&subset=latin-ext' rel='stylesheet' type='text/css'>
    GREEK <link href='https://fonts.googleapis.com/css?family=Open+Sans:700,400&subset=greek-ext' rel='stylesheet' type='text/css'>
    RUSSIA <link href='https://fonts.googleapis.com/css?family=Open+Sans:700,400&subset=cyrillic-ext,latin' rel='stylesheet' type='text/css'>
    -->

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link rel="stylesheet" href="../_static/pygments.css" type="text/css">
    <link rel="stylesheet" href="../_static/docs.css" type="text/css">
    

    
    
    <link rel="shortcut icon" href="../_static/favicon.ico">
    <link rel="top" title="Phalcon 2.0.0 documentation" href="../index.html">
    <link rel="next" title="ODM (Object-Document Mapper)" href="odm.html">
    <link rel="prev" title="Phalcon Query Language (PHQL)" href="phql.html"> 
  </head>
  <body>




    <!--<div class="header-line">
      <div class="size-wrap">
        <div class="header-line-title title-white">Documentation</div>
      </div>
    </div>-->
      

      <table width="100%" align="center" cellpadding="0" cellspacing="0">
        <tr>
      
          <td class="second-box" valign="top">
            <div class="document">
                <div class="documentwrapper">
                  <div class="bodywrapper">
                    <div class="body">
                      
  <div class="section" id="caching-in-the-orm">
<h1>Caching in the ORM</h1>
<p>Every application is different, we could have models whose data change frequently and others that rarely change.
Accessing database systems is often one of the most common bottlenecks in terms of performance. This is due to
the complex connection/communication processes that PHP must do in each request to obtain data from the database.
Therefore, if we want to achieve good performance we need to add some layers of caching where the
application requires it.</p>
<p>This chapter explains the possible points where it is possible to implement caching to improve performance.
The framework gives you the tools to implement the cache where you demand of it according to the architecture
of your application.</p>
<div class="section" id="caching-resultsets">
<h2>Caching Resultsets<a class="headerlink" href="models-cache.html#caching-resultsets" title="Permalink to this headline">¶</a>
</h2>
<p>A well established technique to avoid the continuous access to the database is to cache resultsets that don’t change
frequently using a system with faster access (usually memory).</p>
<p>When <a class="reference internal" href="../api/Phalcon_Mvc_Model.html"><em>Phalcon\Mvc\Model</em></a> requires a service to cache resultsets, it will
request it to the Dependency Injector Container with the convention name “modelsCache”.</p>
<p>As Phalcon provides a component to <a class="reference internal" href="cache.html"><em>cache</em></a> any kind of data, we’ll explain how to integrate it with Models.
First, you must register it as a service in the services container:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Cache\Frontend\Data</span> <span class="k">as</span> <span class="nx">FrontendData</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Cache\Backend\Memcache</span> <span class="k">as</span> <span class="nx">BackendMemcache</span><span class="p">;</span>

<span class="c1">//Set the models cache service</span>
<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">'modelsCache'</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">//Cache data for one day by default</span>
    <span class="nv">$frontCache</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FrontendData</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
        <span class="s2">"lifetime"</span> <span class="o">=&gt;</span> <span class="mi">86400</span>
    <span class="p">));</span>

    <span class="c1">//Memcached connection settings</span>
    <span class="nv">$cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BackendMemcache</span><span class="p">(</span><span class="nv">$frontCache</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
        <span class="s2">"host"</span> <span class="o">=&gt;</span> <span class="s2">"localhost"</span><span class="p">,</span>
        <span class="s2">"port"</span> <span class="o">=&gt;</span> <span class="s2">"11211"</span>
    <span class="p">));</span>

    <span class="k">return</span> <span class="nv">$cache</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
<p>You have complete control in creating and customizing the cache before being used by registering the service
as an anonymous function. Once the cache setup is properly defined you could cache resultsets as follows:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Get products without caching</span>
<span class="nv">$products</span> <span class="o">=</span> <span class="nx">Products</span><span class="o">::</span><span class="na">find</span><span class="p">();</span>

<span class="c1">// Just cache the resultset. The cache will expire in 1 hour (3600 seconds)</span>
<span class="nv">$products</span> <span class="o">=</span> <span class="nx">Products</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s2">"cache"</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">"key"</span> <span class="o">=&gt;</span> <span class="s2">"my-cache"</span><span class="p">)</span>
<span class="p">));</span>

<span class="c1">// Cache the resultset for only for 5 minutes</span>
<span class="nv">$products</span> <span class="o">=</span> <span class="nx">Products</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s2">"cache"</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">"key"</span> <span class="o">=&gt;</span> <span class="s2">"my-cache"</span><span class="p">,</span> <span class="s2">"lifetime"</span> <span class="o">=&gt;</span> <span class="mi">300</span><span class="p">)</span>
<span class="p">));</span>

<span class="c1">// Using a custom cache</span>
<span class="nv">$products</span> <span class="o">=</span> <span class="nx">Products</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s2">"cache"</span> <span class="o">=&gt;</span> <span class="nv">$myCache</span><span class="p">));</span>
</pre></div>
</div>
<p>Caching could be also applied to resultsets generated using relationships:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Query some post</span>
<span class="nv">$post</span>     <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">findFirst</span><span class="p">();</span>

<span class="c1">// Get comments related to a post, also cache it</span>
<span class="nv">$comments</span> <span class="o">=</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">getComments</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s2">"cache"</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">"key"</span> <span class="o">=&gt;</span> <span class="s2">"my-key"</span><span class="p">)</span>
<span class="p">));</span>

<span class="c1">// Get comments related to a post, setting lifetime</span>
<span class="nv">$comments</span> <span class="o">=</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">getComments</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s2">"cache"</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">"key"</span> <span class="o">=&gt;</span> <span class="s2">"my-key"</span><span class="p">,</span> <span class="s2">"lifetime"</span> <span class="o">=&gt;</span> <span class="mi">3600</span><span class="p">)</span>
<span class="p">));</span>
</pre></div>
</div>
<p>When a cached resultset needs to be invalidated, you can simply delete it from the cache using the previously specified key.</p>
<p>Note that not all resultsets must be cached. Results that change very frequently should not be cached since they
are invalidated very quickly and caching in that case impacts performance. Additionally, large datasets that
do not change frequently could be cached, but that is a decision that the developer has to make based on the
available caching mechanism and whether the performance impact to simply retrieve that data in the
first place is acceptable.</p>
</div>
<div class="section" id="overriding-find-findfirst">
<h2>Overriding find/findFirst<a class="headerlink" href="models-cache.html#overriding-find-findfirst" title="Permalink to this headline">¶</a>
</h2>
<p>As seen above, these methods are available in models that inherit <a class="reference internal" href="../api/Phalcon_Mvc_Model.html"><em>Phalcon\Mvc\Model</em></a>:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Robots</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">find</span><span class="p">(</span><span class="nv">$parameters</span><span class="o">=</span><span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">findFirst</span><span class="p">(</span><span class="nv">$parameters</span><span class="o">=</span><span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">findFirst</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>By doing this, you’re intercepting all the calls to these methods, this way, you can add a cache
layer or run the query if there is no cache. For example, a very basic cache implementation, uses
a static property to avoid that a record would be queried several times in a same request:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Robots</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>

    <span class="k">protected</span> <span class="k">static</span> <span class="nv">$_cache</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

    <span class="sd">/**</span>
<span class="sd">     * Implement a method that returns a string key based</span>
<span class="sd">     * on the query parameters</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">_createKey</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$uniqueKey</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$parameters</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">is_scalar</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$uniqueKey</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$key</span> <span class="o">.</span> <span class="s1">':'</span> <span class="o">.</span> <span class="nv">$value</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nv">$uniqueKey</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$key</span> <span class="o">.</span> <span class="s1">':['</span> <span class="o">.</span> <span class="nx">self</span><span class="o">::</span><span class="na">_createKey</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span> <span class="o">.</span><span class="s1">']'</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">join</span><span class="p">(</span><span class="s1">','</span><span class="p">,</span> <span class="nv">$uniqueKey</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">find</span><span class="p">(</span><span class="nv">$parameters</span><span class="o">=</span><span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>

        <span class="c1">//Create an unique key based on the parameters</span>
        <span class="nv">$key</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">_createKey</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="nv">$_cache</span><span class="p">[</span><span class="nv">$key</span><span class="p">]))</span> <span class="p">{</span>
            <span class="c1">//Store the result in the memory cache</span>
            <span class="nx">self</span><span class="o">::</span><span class="nv">$_cache</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="k">parent</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">//Return the result in the cache</span>
        <span class="k">return</span> <span class="nx">self</span><span class="o">::</span><span class="nv">$_cache</span><span class="p">[</span><span class="nv">$key</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">findFirst</span><span class="p">(</span><span class="nv">$parameters</span><span class="o">=</span><span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Access the database is several times slower than calculate a cache key, you’re free in implement the
key generation strategy you find better for your needs. Note that a good key avoids collisions as much as possible,
this means that different keys returns unrelated records to the find parameters.</p>
<p>In the above example, we used a cache in memory, it is useful as a first level cache. Once we have the memory cache,
we can implement a second level cache layer like APC/XCache or a NoSQL database:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">find</span><span class="p">(</span><span class="nv">$parameters</span><span class="o">=</span><span class="k">null</span><span class="p">)</span>
<span class="p">{</span>

    <span class="c1">//Create an unique key based on the parameters</span>
    <span class="nv">$key</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">_createKey</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="nv">$_cache</span><span class="p">[</span><span class="nv">$key</span><span class="p">]))</span> <span class="p">{</span>

        <span class="c1">//We're using APC as second cache</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">apc_exists</span><span class="p">(</span><span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>

            <span class="nv">$data</span> <span class="o">=</span> <span class="nb">apc_fetch</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>

            <span class="c1">//Store the result in the memory cache</span>
            <span class="nx">self</span><span class="o">::</span><span class="nv">$_cache</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">;</span>

            <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//There are no memory or apc cache</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="k">parent</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">);</span>

        <span class="c1">//Store the result in the memory cache</span>
        <span class="nx">self</span><span class="o">::</span><span class="nv">$_cache</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">;</span>

        <span class="c1">//Store the result in APC</span>
        <span class="nb">apc_store</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//Return the result in the cache</span>
    <span class="k">return</span> <span class="nx">self</span><span class="o">::</span><span class="nv">$_cache</span><span class="p">[</span><span class="nv">$key</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This gives you full control on how the the caches must be implemented for each model, if this strategy is common to several models
you can create a base class for all of them:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CacheableModel</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>

    <span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">_createKey</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// .. create a cache key based on the parameters</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">find</span><span class="p">(</span><span class="nv">$parameters</span><span class="o">=</span><span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//.. custom caching strategy</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">findFirst</span><span class="p">(</span><span class="nv">$parameters</span><span class="o">=</span><span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//.. custom caching strategy</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Then use this class as base class for each ‘Cacheable’ model:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">Robots</span> <span class="k">extends</span> <span class="nx">CacheableModel</span>
<span class="p">{</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="forcing-cache">
<h2>Forcing Cache<a class="headerlink" href="models-cache.html#forcing-cache" title="Permalink to this headline">¶</a>
</h2>
<p>Earlier we saw how Phalcon\Mvc\Model has a built-in integration with the caching component provided by the framework. To make a record/resultset
cacheable we pass the key ‘cache’ in the array of parameters:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Cache the resultset for only for 5 minutes</span>
<span class="nv">$products</span> <span class="o">=</span> <span class="nx">Products</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s2">"cache"</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s2">"key"</span> <span class="o">=&gt;</span> <span class="s2">"my-cache"</span><span class="p">,</span> <span class="s2">"lifetime"</span> <span class="o">=&gt;</span> <span class="mi">300</span><span class="p">)</span>
<span class="p">));</span>
</pre></div>
</div>
<p>This gives us the freedom to cache specific queries, however if we want to cache globally every query performed over the model,
we can override the find/findFirst method to force every query to be cached:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Robots</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>

    <span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">_createKey</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// .. create a cache key based on the parameters</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">find</span><span class="p">(</span><span class="nv">$parameters</span><span class="o">=</span><span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>

        <span class="c1">//Convert the parameters to an array</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$parameters</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">//Check if a cache key wasn't passed</span>
        <span class="c1">//and create the cache parameters</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$parameters</span><span class="p">[</span><span class="s1">'cache'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
                <span class="s2">"key"</span>      <span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">_createKey</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">),</span>
                <span class="s2">"lifetime"</span> <span class="o">=&gt;</span> <span class="mi">300</span>
            <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">findFirst</span><span class="p">(</span><span class="nv">$parameters</span><span class="o">=</span><span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="caching-phql-queries">
<h2>Caching PHQL Queries<a class="headerlink" href="models-cache.html#caching-phql-queries" title="Permalink to this headline">¶</a>
</h2>
<p>All queries in the ORM, no matter how high level syntax we used to create them are handled internally using PHQL.
This language gives you much more freedom to create all kinds of queries. Of course these queries can be cached:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$phql</span> <span class="o">=</span> <span class="s2">"SELECT * FROM Cars WHERE name = :name:"</span><span class="p">;</span>

<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">modelsManager</span><span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span><span class="nv">$phql</span><span class="p">);</span>

<span class="nv">$query</span><span class="o">-&gt;</span><span class="na">cache</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s2">"key"</span>      <span class="o">=&gt;</span> <span class="s2">"cars-by-name"</span><span class="p">,</span>
    <span class="s2">"lifetime"</span> <span class="o">=&gt;</span> <span class="mi">300</span>
<span class="p">));</span>

<span class="nv">$cars</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'Audi'</span>
<span class="p">));</span>
</pre></div>
</div>
<p>If you don’t want to use the implicit cache just save the resulset into your favorite cache backend:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$phql</span> <span class="o">=</span> <span class="s2">"SELECT * FROM Cars WHERE name = :name:"</span><span class="p">;</span>

<span class="nv">$cars</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">modelsManager</span><span class="o">-&gt;</span><span class="na">executeQuery</span><span class="p">(</span><span class="nv">$phql</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'Audi'</span>
<span class="p">));</span>

<span class="nb">apc_store</span><span class="p">(</span><span class="s1">'my-cars'</span><span class="p">,</span> <span class="nv">$cars</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="reusable-related-records">
<h2>Reusable Related Records<a class="headerlink" href="models-cache.html#reusable-related-records" title="Permalink to this headline">¶</a>
</h2>
<p>Some models may have relationships to other models. This allows us to easily check the records that relate to instances in memory:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">//Get some invoice</span>
<span class="nv">$invoice</span>  <span class="o">=</span> <span class="nx">Invoices</span><span class="o">::</span><span class="na">findFirst</span><span class="p">();</span>

<span class="c1">//Get the customer related to the invoice</span>
<span class="nv">$customer</span> <span class="o">=</span> <span class="nv">$invoice</span><span class="o">-&gt;</span><span class="na">customer</span><span class="p">;</span>

<span class="c1">//Print his/her name</span>
<span class="k">echo</span> <span class="nv">$customer</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
</pre></div>
</div>
<p>This example is very simple, a customer is queried and can be used as required, for example, to show its name.
This also applies if we retrieve a set of invoices to show customers that correspond to these invoices:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">//Get a set of invoices</span>
<span class="c1">// SELECT * FROM invoices;</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nx">Invoices</span><span class="o">::</span><span class="na">find</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$invoice</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">//Get the customer related to the invoice</span>
    <span class="c1">// SELECT * FROM customers WHERE id = ?;</span>
    <span class="nv">$customer</span> <span class="o">=</span> <span class="nv">$invoice</span><span class="o">-&gt;</span><span class="na">customer</span><span class="p">;</span>

    <span class="c1">//Print his/her name</span>
    <span class="k">echo</span> <span class="nv">$customer</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A customer may have one or more bills, this means that the customer may be unnecessarily more than once.
To avoid this, we could mark the relationship as reusable, this way, we tell the ORM to automatically reuse
the records instead of re-querying them again and again:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Invoices</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span><span class="s2">"customers_id"</span><span class="p">,</span> <span class="s2">"Customer"</span><span class="p">,</span> <span class="s2">"id"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">'reusable'</span> <span class="o">=&gt;</span> <span class="k">true</span>
        <span class="p">));</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>This cache works in memory only, this means that cached data are released when the request is terminated. You can
add a more sophisticated cache for this scenario overriding the models manager:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model\Manager</span> <span class="k">as</span> <span class="nx">ModelManager</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CustomModelsManager</span> <span class="k">extends</span> <span class="nx">ModelManager</span>
<span class="p">{</span>

    <span class="sd">/**</span>
<span class="sd">     * Returns a reusable object from the cache</span>
<span class="sd">     *</span>
<span class="sd">     * @param string $modelName</span>
<span class="sd">     * @param string $key</span>
<span class="sd">     * @return object</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getReusableRecords</span><span class="p">(</span><span class="nv">$modelName</span><span class="p">,</span> <span class="nv">$key</span><span class="p">){</span>

        <span class="c1">//If the model is Products use the APC cache</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$modelName</span> <span class="o">==</span> <span class="s1">'Products'</span><span class="p">){</span>
            <span class="k">return</span> <span class="nb">apc_fetch</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">//For the rest, use the memory cache</span>
        <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">getReusableRecords</span><span class="p">(</span><span class="nv">$modelName</span><span class="p">,</span> <span class="nv">$key</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Stores a reusable record in the cache</span>
<span class="sd">     *</span>
<span class="sd">     * @param string $modelName</span>
<span class="sd">     * @param string $key</span>
<span class="sd">     * @param mixed $records</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">setReusableRecords</span><span class="p">(</span><span class="nv">$modelName</span><span class="p">,</span> <span class="nv">$key</span><span class="p">,</span> <span class="nv">$records</span><span class="p">){</span>

        <span class="c1">//If the model is Products use the APC cache</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$modelName</span> <span class="o">==</span> <span class="s1">'Products'</span><span class="p">){</span>
            <span class="nb">apc_store</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$records</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//For the rest, use the memory cache</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">setReusableRecords</span><span class="p">(</span><span class="nv">$modelName</span><span class="p">,</span> <span class="nv">$key</span><span class="p">,</span> <span class="nv">$records</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Do not forget to register the custom models manager in the DI:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">setShared</span><span class="p">(</span><span class="s1">'modelsManager'</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">CustomModelsManager</span><span class="p">();</span>
<span class="p">});</span>
</pre></div>
</div>
</div>
<div class="section" id="caching-related-records">
<h2>Caching Related Records<a class="headerlink" href="models-cache.html#caching-related-records" title="Permalink to this headline">¶</a>
</h2>
<p>When a related record is queried, the ORM internally builds the appropriate condition and gets the required records using find/findFirst
in the target model according to the following table:</p>
<table border="1" class="docutils">
<colgroup>
<col width="16%">
<col width="84%">
</colgroup>
<thead valign="bottom">
<tr class="row-odd">
<th class="head">Type</th>
<th class="head">Description                                                                          | Implicit Method</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even">
<td>Belongs-To</td>
<td>Returns a model instance of the related record directly                              | findFirst</td>
</tr>
<tr class="row-odd">
<td>Has-One</td>
<td>Returns a model instance of the related record directly                              | findFirst</td>
</tr>
<tr class="row-even">
<td>Has-Many</td>
<td>Returns a collection of model instances of the referenced model                      | find</td>
</tr>
</tbody>
</table>
<p>This means that when you get a related record you could intercept how these data are obtained by implementing the corresponding method:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">//Get some invoice</span>
<span class="nv">$invoice</span>  <span class="o">=</span> <span class="nx">Invoices</span><span class="o">::</span><span class="na">findFirst</span><span class="p">();</span>

<span class="c1">//Get the customer related to the invoice</span>
<span class="nv">$customer</span> <span class="o">=</span> <span class="nv">$invoice</span><span class="o">-&gt;</span><span class="na">customer</span><span class="p">;</span> <span class="c1">// Invoices::findFirst('...');</span>

<span class="c1">//Same as above</span>
<span class="nv">$customer</span> <span class="o">=</span> <span class="nv">$invoice</span><span class="o">-&gt;</span><span class="na">getCustomer</span><span class="p">();</span> <span class="c1">// Invoices::findFirst('...');</span>
</pre></div>
</div>
<p>Accordingly, we could replace the findFirst method in the model Invoices and implement the cache we consider most appropriate:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Invoices</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">findFirst</span><span class="p">(</span><span class="nv">$parameters</span><span class="o">=</span><span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//.. custom caching strategy</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="caching-related-records-recursively">
<h2>Caching Related Records Recursively<a class="headerlink" href="models-cache.html#caching-related-records-recursively" title="Permalink to this headline">¶</a>
</h2>
<p>In this scenario, we assume that everytime we query a result we also retrieve their associated records.
If we store the records found together with their related entities perhaps we could reduce a bit the overhead required
to obtain all entities:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Invoices</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>

    <span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">_createKey</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// .. create a cache key based on the parameters</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">_getCache</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// returns data from a cache</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">_setCache</span><span class="p">(</span><span class="nv">$key</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// stores data in the cache</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">find</span><span class="p">(</span><span class="nv">$parameters</span><span class="o">=</span><span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//Create a unique key</span>
        <span class="nv">$key</span>     <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">_createKey</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">);</span>

        <span class="c1">//Check if there are data in the cache</span>
        <span class="nv">$results</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">_getCache</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>

        <span class="c1">// Valid data is an object</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">is_object</span><span class="p">(</span><span class="nv">$results</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$results</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$results</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

        <span class="nv">$invoices</span> <span class="o">=</span> <span class="k">parent</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">);</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$invoices</span> <span class="k">as</span> <span class="nv">$invoice</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">//Query the related customer</span>
            <span class="nv">$customer</span> <span class="o">=</span> <span class="nv">$invoice</span><span class="o">-&gt;</span><span class="na">customer</span><span class="p">;</span>

            <span class="c1">//Assign it to the record</span>
            <span class="nv">$invoice</span><span class="o">-&gt;</span><span class="na">customer</span> <span class="o">=</span> <span class="nv">$customer</span><span class="p">;</span>

            <span class="nv">$results</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$invoice</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//Store the invoices in the cache + their customers</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">_setCache</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$results</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$results</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// add relations and initialize other stuff</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Getting the invoices from the cache already obtains the customer data in just one hit, reducing the overall overhead of the operation.
Note that this process can also be performed with PHQL following an alternative solution:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Invoices</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">initialize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// add relations and initialize other stuff</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">_createKey</span><span class="p">(</span><span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$params</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// .. create a cache key based on the parameters</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getInvoicesCustomers</span><span class="p">(</span><span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$params</span><span class="o">=</span><span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$phql</span>  <span class="o">=</span> <span class="s2">"SELECT Invoices.*, Customers.*</span>
<span class="s2">        FROM Invoices JOIN Customers WHERE "</span> <span class="o">.</span> <span class="nv">$conditions</span><span class="p">;</span>

        <span class="nv">$query</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getModelsManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">executeQuery</span><span class="p">(</span><span class="nv">$phql</span><span class="p">);</span>

        <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">cache</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
            <span class="s2">"key"</span>      <span class="o">=&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">_createKey</span><span class="p">(</span><span class="nv">$conditions</span><span class="p">,</span> <span class="nv">$params</span><span class="p">),</span>
            <span class="s2">"lifetime"</span> <span class="o">=&gt;</span> <span class="mi">300</span>
        <span class="p">));</span>

        <span class="k">return</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="nv">$params</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="caching-based-on-conditions">
<h2>Caching based on Conditions<a class="headerlink" href="models-cache.html#caching-based-on-conditions" title="Permalink to this headline">¶</a>
</h2>
<p>In this scenario, the cache is implemented conditionally according to current conditions received.
According to the range where the primary key is located we choose a different cache backend:</p>
<table border="1" class="docutils">
<colgroup>
<col width="51%">
<col width="49%">
</colgroup>
<thead valign="bottom">
<tr class="row-odd">
<th class="head">Type</th>
<th class="head">Cache Backend</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even">
<td>1 - 10000</td>
<td>mongo1</td>
</tr>
<tr class="row-odd">
<td>10000 - 20000</td>
<td>mongo2</td>
</tr>
<tr class="row-even">
<td>&gt; 20000</td>
<td>mongo3</td>
</tr>
</tbody>
</table>
<p>The easiest way is adding an static method to the model that chooses the right cache to be used:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Robots</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">queryCache</span><span class="p">(</span><span class="nv">$initial</span><span class="p">,</span> <span class="nv">$final</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$initial</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nv">$final</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">self</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
                <span class="s1">'id &gt;= '</span> <span class="o">.</span> <span class="nv">$initial</span> <span class="o">.</span> <span class="s1">' AND id &lt;= '</span><span class="o">.</span><span class="nv">$final</span><span class="p">,</span>
                <span class="s1">'cache'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'service'</span> <span class="o">=&gt;</span> <span class="s1">'mongo1'</span><span class="p">)</span>
            <span class="p">));</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$initial</span> <span class="o">&gt;=</span> <span class="mi">10000</span> <span class="o">&amp;&amp;</span> <span class="nv">$final</span> <span class="o">&lt;=</span> <span class="mi">20000</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">self</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
                <span class="s1">'id &gt;= '</span> <span class="o">.</span> <span class="nv">$initial</span> <span class="o">.</span> <span class="s1">' AND id &lt;= '</span><span class="o">.</span><span class="nv">$final</span><span class="p">,</span>
                <span class="s1">'cache'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'service'</span> <span class="o">=&gt;</span> <span class="s1">'mongo2'</span><span class="p">)</span>
            <span class="p">));</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$initial</span> <span class="o">&gt;</span> <span class="mi">20000</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">self</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
                <span class="s1">'id &gt;= '</span> <span class="o">.</span> <span class="nv">$initial</span><span class="p">,</span>
                <span class="s1">'cache'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'service'</span> <span class="o">=&gt;</span> <span class="s1">'mongo3'</span><span class="p">)</span>
            <span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>This approach solves the problem, however, if we want to add other parameters such orders or conditions we would have to create
a more complicated method. Additionally, this method does not work if the data is obtained using related records or a find/findFirst:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$robots</span> <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="s1">'id &lt; 1000'</span><span class="p">);</span>
<span class="nv">$robots</span> <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="s1">'id &gt; 100 AND type = "A"'</span><span class="p">);</span>
<span class="nv">$robots</span> <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="s1">'(id &gt; 100 AND type = "A") AND id &lt; 2000'</span><span class="p">);</span>

<span class="nv">$robots</span> <span class="o">=</span> <span class="nx">Robots</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s1">'(id &gt; ?0 AND type = "A") AND id &lt; ?1'</span><span class="p">,</span>
    <span class="s1">'bind'</span>  <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2000</span><span class="p">),</span>
    <span class="s1">'order'</span> <span class="o">=&gt;</span> <span class="s1">'type'</span>
<span class="p">));</span>
</pre></div>
</div>
<p>To achieve this we need to intercept the intermediate representation (IR) generated by the PHQL parser and
thus customize the cache everything possible:</p>
<p>The first is create a custom builder, so we can generate a totally customized query:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model\Query\Builder</span> <span class="k">as</span> <span class="nx">QueryBuilder</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CustomQueryBuilder</span> <span class="k">extends</span> <span class="nx">QueryBuilder</span>
<span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getQuery</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$query</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CustomQuery</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getPhql</span><span class="p">());</span>
        <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">setDI</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDI</span><span class="p">());</span>
        <span class="k">return</span> <span class="nv">$query</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Instead of directly returning a Phalcon\Mvc\Model\Query, our custom builder returns a CustomQuery instance,
this class looks like:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model\Query</span> <span class="k">as</span> <span class="nx">ModelQuery</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CustomQuery</span> <span class="k">extends</span> <span class="nx">ModelQuery</span>
<span class="p">{</span>

    <span class="sd">/**</span>
<span class="sd">     * The execute method is overridden</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">execute</span><span class="p">(</span><span class="nv">$params</span><span class="o">=</span><span class="k">null</span><span class="p">,</span> <span class="nv">$types</span><span class="o">=</span><span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//Parse the intermediate representation for the SELECT</span>
        <span class="nv">$ir</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parse</span><span class="p">();</span>

        <span class="c1">//Check if the query has conditions</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$ir</span><span class="p">[</span><span class="s1">'where'</span><span class="p">]))</span> <span class="p">{</span>

            <span class="c1">//The fields in the conditions can have any order</span>
            <span class="c1">//We need to recursively check the conditions tree</span>
            <span class="c1">//to find the info we're looking for</span>
            <span class="nv">$visitor</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CustomNodeVisitor</span><span class="p">();</span>

            <span class="c1">//Recursively visits the nodes</span>
            <span class="nv">$visitor</span><span class="o">-&gt;</span><span class="na">visit</span><span class="p">(</span><span class="nv">$ir</span><span class="p">[</span><span class="s1">'where'</span><span class="p">]);</span>

            <span class="nv">$initial</span> <span class="o">=</span> <span class="nv">$visitor</span><span class="o">-&gt;</span><span class="na">getInitial</span><span class="p">();</span>
            <span class="nv">$final</span>   <span class="o">=</span> <span class="nv">$visitor</span><span class="o">-&gt;</span><span class="na">getFinal</span><span class="p">();</span>

            <span class="c1">//Select the cache according to the range</span>
            <span class="c1">//...</span>

            <span class="c1">//Check if the cache has data</span>
            <span class="c1">//...</span>
        <span class="p">}</span>

        <span class="c1">//Execute the query</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_executeSelect</span><span class="p">(</span><span class="nv">$ir</span><span class="p">,</span> <span class="nv">$params</span><span class="p">,</span> <span class="nv">$types</span><span class="p">);</span>

        <span class="c1">//cache the result</span>
        <span class="c1">//...</span>

        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Implementing a helper (CustomNodeVisitor) that recursively checks the conditions looking for fields that
tell us the possible range to be used in the cache:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">CustomNodeVisitor</span>
<span class="p">{</span>

    <span class="k">protected</span> <span class="nv">$_initial</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$_final</span> <span class="o">=</span> <span class="mi">25000</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">visit</span><span class="p">(</span><span class="nv">$node</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nv">$node</span><span class="p">[</span><span class="s1">'type'</span><span class="p">])</span> <span class="p">{</span>

            <span class="k">case</span> <span class="s1">'binary-op'</span><span class="o">:</span>

                <span class="nv">$left</span>  <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">visit</span><span class="p">(</span><span class="nv">$node</span><span class="p">[</span><span class="s1">'left'</span><span class="p">]);</span>
                <span class="nv">$right</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">visit</span><span class="p">(</span><span class="nv">$node</span><span class="p">[</span><span class="s1">'right'</span><span class="p">]);</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$left</span> <span class="o">||</span> <span class="o">!</span><span class="nv">$right</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="nv">$left</span><span class="o">==</span><span class="s1">'id'</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span><span class="p">[</span><span class="s1">'op'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'&gt;'</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_initial</span> <span class="o">=</span> <span class="nv">$right</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span><span class="p">[</span><span class="s1">'op'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'='</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_initial</span> <span class="o">=</span> <span class="nv">$right</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span><span class="p">[</span><span class="s1">'op'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'&gt;='</span><span class="p">)</span>    <span class="p">{</span>
                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_initial</span> <span class="o">=</span> <span class="nv">$right</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span><span class="p">[</span><span class="s1">'op'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'&lt;'</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_final</span> <span class="o">=</span> <span class="nv">$right</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span><span class="p">[</span><span class="s1">'op'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'&lt;='</span><span class="p">)</span>    <span class="p">{</span>
                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_final</span> <span class="o">=</span> <span class="nv">$right</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="s1">'qualified'</span><span class="o">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$node</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'id'</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="s1">'id'</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="s1">'literal'</span><span class="o">:</span>
                <span class="k">return</span> <span class="nv">$node</span><span class="p">[</span><span class="s1">'value'</span><span class="p">];</span>

            <span class="k">default</span><span class="o">:</span>
                <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getInitial</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_initial</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getFinal</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_final</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Finally, we can replace the find method in the Robots model to use the custom classes we’ve created:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Robots</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">find</span><span class="p">(</span><span class="nv">$parameters</span><span class="o">=</span><span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$parameters</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CustomQueryBuilder</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">);</span>
        <span class="nv">$builder</span><span class="o">-&gt;</span><span class="na">from</span><span class="p">(</span><span class="nb">get_called_class</span><span class="p">());</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">[</span><span class="s1">'bind'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$builder</span><span class="o">-&gt;</span><span class="na">getQuery</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="nv">$parameters</span><span class="p">[</span><span class="s1">'bind'</span><span class="p">]);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$builder</span><span class="o">-&gt;</span><span class="na">getQuery</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">();</span>
        <span class="p">}</span>

    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="caching-of-phql-planning">
<h2>Caching of PHQL planning<a class="headerlink" href="models-cache.html#caching-of-phql-planning" title="Permalink to this headline">¶</a>
</h2>
<p>As well as most moderns database systems PHQL internally caches the execution plan,
if the same statement is executed several times PHQL reuses the previously generated plan
improving performance, for a developer to take better advantage of this is highly recommended
build all your SQL statements passing variable parameters as bound parameters:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

    <span class="nv">$phql</span>   <span class="o">=</span> <span class="s2">"SELECT * FROM Store</span><span class="se">\R</span><span class="s2">obots WHERE id = "</span> <span class="o">.</span> <span class="nv">$i</span><span class="p">;</span>
    <span class="nv">$robots</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">modelsManager</span><span class="o">-&gt;</span><span class="na">executeQuery</span><span class="p">(</span><span class="nv">$phql</span><span class="p">);</span>

    <span class="c1">//...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the above example, ten plans were generated increasing the memory usage and processing in the application.
Rewriting the code to take advantage of bound parameters reduces the processing by both ORM and database system:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$phql</span> <span class="o">=</span> <span class="s2">"SELECT * FROM Store</span><span class="se">\R</span><span class="s2">obots WHERE id = ?0"</span><span class="p">;</span>

<span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

    <span class="nv">$robots</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">modelsManager</span><span class="o">-&gt;</span><span class="na">executeQuery</span><span class="p">(</span><span class="nv">$phql</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$i</span><span class="p">));</span>

    <span class="c1">//...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Performance can be also improved reusing the PHQL query:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$phql</span>  <span class="o">=</span> <span class="s2">"SELECT * FROM Store</span><span class="se">\R</span><span class="s2">obots WHERE id = ?0"</span><span class="p">;</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">modelsManager</span><span class="o">-&gt;</span><span class="na">createQuery</span><span class="p">(</span><span class="nv">$phql</span><span class="p">);</span>

<span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

    <span class="nv">$robots</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="nv">$phql</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$i</span><span class="p">));</span>

    <span class="c1">//...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Execution plans for queries involving <a class="reference external" href="http://en.wikipedia.org/wiki/Prepared_statement">prepared statements</a> are also cached by most database systems
reducing the overall execution time, also protecting your application against <a class="reference external" href="http://en.wikipedia.org/wiki/SQL_injection">SQL Injections</a>.</p>
</div>
</div>


                    </div>
                  </div>
                </div>
            </div>
          </td>
        </tr>
      </table>
    

      


    
    

  </body>
</html>
