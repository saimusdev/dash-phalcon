<!DOCTYPE html>
<html lang="en">
  <head>
    
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    
    <title>Tutorial 3: Securing INVO — Phalcon 2.0.0 documentation</title>
    <meta name="keywords" content="php, phalcon, phalcon php, php framework, faster php framework">
<link rel="stylesheet" type="text/css" href="http://netdna.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="http://static.phalconphp.com/css/phalcon.min.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:700,400" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Merriweather:400,700" rel="stylesheet" type="text/css">
    <!--
    EUROPE <link href='https://fonts.googleapis.com/css?family=Open+Sans:700,400&subset=latin-ext' rel='stylesheet' type='text/css'>
    GREEK <link href='https://fonts.googleapis.com/css?family=Open+Sans:700,400&subset=greek-ext' rel='stylesheet' type='text/css'>
    RUSSIA <link href='https://fonts.googleapis.com/css?family=Open+Sans:700,400&subset=cyrillic-ext,latin' rel='stylesheet' type='text/css'>
    -->

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link rel="stylesheet" href="../_static/pygments.css" type="text/css">
    <link rel="stylesheet" href="../_static/docs.css" type="text/css">
    

    
    
    <link rel="shortcut icon" href="../_static/favicon.ico">
    <link rel="top" title="Phalcon 2.0.0 documentation" href="../index.html">
    <link rel="next" title="Tutorial 4: Using CRUDs" href="tutorial-invo-3.html">
    <link rel="prev" title="Tutorial 2: Introducing INVO" href="tutorial-invo.html"> 
  </head>
  <body>




    <!--<div class="header-line">
      <div class="size-wrap">
        <div class="header-line-title title-white">Documentation</div>
      </div>
    </div>-->
      

      <table width="100%" align="center" cellpadding="0" cellspacing="0">
        <tr>
      
          <td class="second-box" valign="top">
            <div class="document">
                <div class="documentwrapper">
                  <div class="bodywrapper">
                    <div class="body">
                      
  <div class="section" id="tutorial-3-securing-invo">
<h1>Tutorial 3: Securing INVO</h1>
<p>In this chapter, we continue explaining how INVO is structured, we’ll talk
about the implementation of authentication, authorization using events and plugins and
an access control list (ACL) managed by Phalcon.</p>
<div class="section" id="log-into-the-application">
<h2>Log into the Application<a class="headerlink" href="tutorial-invo-2.html#log-into-the-application" title="Permalink to this headline">¶</a>
</h2>
<p>A “log in” facility will allow us to work on backend controllers. The separation between backend controllers and
frontend ones is only logical. All controllers are located in the same directory (app/controllers/).</p>
<p>To enter the system, users must have a valid username and password. Users are stored in the table “users”
in the database “invo”.</p>
<p>Before we can start a session, we need to configure the connection to the database in the application. A service
called “db” is set up in the service container with the connection information. As with the autoloader, we are
again taking parameters from the configuration file in order to configure a service:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Db\Adapter\Pdo\Mysql</span> <span class="k">as</span> <span class="nx">DbAdapter</span><span class="p">;</span>

<span class="c1">// ...</span>

<span class="c1">// Database connection is created based on parameters defined in the configuration file</span>
<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">'db'</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$config</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">DbAdapter</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
        <span class="s2">"host"</span>     <span class="o">=&gt;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">database</span><span class="o">-&gt;</span><span class="na">host</span><span class="p">,</span>
        <span class="s2">"username"</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">database</span><span class="o">-&gt;</span><span class="na">username</span><span class="p">,</span>
        <span class="s2">"password"</span> <span class="o">=&gt;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">database</span><span class="o">-&gt;</span><span class="na">password</span><span class="p">,</span>
        <span class="s2">"dbname"</span>   <span class="o">=&gt;</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="na">database</span><span class="o">-&gt;</span><span class="na">name</span>
    <span class="p">));</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Here, we return an instance of the MySQL connection adapter. If needed, you could do extra actions such as adding a
logger, a profiler or change the adapter, setting it up as you want.</p>
<p>The following simple form (app/views/session/index.volt) requests the login information. We’ve removed
some HTML code to make the example more concise:</p>
<div class="highlight-html+jinja">
<div class="highlight"><pre><span class="cp">{{</span> <span class="nv">form</span><span class="o">(</span><span class="s1">'session/start'</span><span class="o">)</span> <span class="cp">}}</span>
    <span class="nt">&lt;fieldset&gt;</span>
        <span class="nt">&lt;div&gt;</span>
            <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"email"</span><span class="nt">&gt;</span>Username/Email<span class="nt">&lt;/label&gt;</span>
            <span class="nt">&lt;div&gt;</span>
                <span class="cp">{{</span> <span class="nv">text_field</span><span class="o">(</span><span class="s1">'email'</span><span class="o">)</span> <span class="cp">}}</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div&gt;</span>
            <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"password"</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
            <span class="nt">&lt;div&gt;</span>
                <span class="cp">{{</span> <span class="nv">password_field</span><span class="o">(</span><span class="s1">'password'</span><span class="o">)</span> <span class="cp">}}</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div&gt;</span>
            <span class="cp">{{</span> <span class="nv">submit_button</span><span class="o">(</span><span class="s1">'Login'</span><span class="o">)</span> <span class="cp">}}</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/fieldset&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
<p>Instead of using raw PHP as the previous tutorial, we started to use <a class="reference internal" href="volt.html"><em>Volt</em></a>. This is a built-in
template engine inspired in <a href="tutorial-invo-2.html#id1"><span class="problematic" id="id2">Jinja_</span></a> providing a simpler and friendly syntax to create templates.
It will not take too long before you become familiar with Volt.</p>
<p>The SessionController::startAction function (app/controllers/SessionController.php) has the task of validating the
data entered in the form including checking for a valid user in the database:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">SessionController</span> <span class="k">extends</span> <span class="nx">ControllerBase</span>
<span class="p">{</span>

    <span class="c1">// ...</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">_registerSession</span><span class="p">(</span><span class="nv">$user</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">session</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">'auth'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">'id'</span>    <span class="o">=&gt;</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span>
            <span class="s1">'name'</span>  <span class="o">=&gt;</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">name</span>
        <span class="p">));</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * This action authenticate and logs an user into the application</span>
<span class="sd">     *</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">startAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">isPost</span><span class="p">())</span> <span class="p">{</span>

            <span class="nv">$email</span>      <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s1">'email'</span><span class="p">);</span>
            <span class="nv">$password</span>   <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s1">'password'</span><span class="p">);</span>

            <span class="nv">$user</span> <span class="o">=</span> <span class="nx">Users</span><span class="o">::</span><span class="na">findFirst</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
                <span class="s2">"(email = :email: OR username = :email:) AND password = :password: AND active = 'Y'"</span><span class="p">,</span>
                <span class="s1">'bind'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="nv">$email</span><span class="p">,</span> <span class="s1">'password'</span> <span class="o">=&gt;</span> <span class="nb">sha1</span><span class="p">(</span><span class="nv">$password</span><span class="p">))</span>
            <span class="p">));</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$user</span> <span class="o">!=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_registerSession</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flash</span><span class="o">-&gt;</span><span class="na">success</span><span class="p">(</span><span class="s1">'Welcome '</span> <span class="o">.</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">);</span>
                <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="s1">'invoices/index'</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flash</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span><span class="s1">'Wrong email/password'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="s1">'session/index'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>For the sake of simplicity, we have used “<a class="reference external" href="http://php.net/manual/en/function.sha1.php">sha1</a>” to store the password hashes in the database, however, this algorithm is
not recommended in real applications, use “<a class="reference internal" href="security.html"><em>bcrypt</em></a>” instead.</p>
<p>Note that multiple public attributes are accessed in the controller like: $this-&gt;flash, $this-&gt;request or $this-&gt;session.
These are services defined in the services container from earlier (app/config/services.php).
When they’re accessed the first time, they are injected as part of the controller.</p>
<p>These services are “shared”, which means that we are always accessing the same instance regardless of the place
where we invoke them.</p>
<p>For instance, here we invoke the “session” service and then we store the user identity in the variable “auth”:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">session</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">'auth'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'id'</span>    <span class="o">=&gt;</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span>
    <span class="s1">'name'</span>  <span class="o">=&gt;</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">name</span>
<span class="p">));</span>
</pre></div>
</div>
<p>Another important aspect of this section is how the user is validated as a valid one,
first we validate whether the request has been made using method POST:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">isPost</span><span class="p">())</span> <span class="p">{</span>
</pre></div>
</div>
<p>Then, we receive the parameters from the form:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$email</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s1">'email'</span><span class="p">);</span>
<span class="nv">$password</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">(</span><span class="s1">'password'</span><span class="p">);</span>
</pre></div>
</div>
<p>Now, we have to check if there is one user with the same username or email and password:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$user</span> <span class="o">=</span> <span class="nx">Users</span><span class="o">::</span><span class="na">findFirst</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
    <span class="s2">"(email = :email: OR username = :email:) AND password = :password: AND active = 'Y'"</span><span class="p">,</span>
    <span class="s1">'bind'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="nv">$email</span><span class="p">,</span> <span class="s1">'password'</span> <span class="o">=&gt;</span> <span class="nb">sha1</span><span class="p">(</span><span class="nv">$password</span><span class="p">))</span>
<span class="p">));</span>
</pre></div>
</div>
<p>Note, the use of ‘bound parameters’, placeholders :email: and :password: are placed where values should be,
then the values are ‘bound’ using the parameter ‘bind’. This safely replaces the values for those
columns without having the risk of a SQL injection.</p>
<p>If the user is valid we register it in session and forwards him/her to the dashboard:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$user</span> <span class="o">!=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_registerSession</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flash</span><span class="o">-&gt;</span><span class="na">success</span><span class="p">(</span><span class="s1">'Welcome '</span> <span class="o">.</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="s1">'invoices/index'</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If the user does not exist we forward the user back again to action where the form is displayed:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span><span class="s1">'session/index'</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="securing-the-backend">
<h2>Securing the Backend<a class="headerlink" href="tutorial-invo-2.html#securing-the-backend" title="Permalink to this headline">¶</a>
</h2>
<p>The backend is a private area where only registered users have access. Therefore, it is necessary
to check that only registered users have access to these controllers. If you aren’t logged
into the application and you try to access, for example, the products controller (which is private)
you will see a screen like this:</p>
<div class="figure align-center">
<img alt="../_images/invo-2.png" src="../_images/invo-2.png">
</div>
<p>Every time someone attempts to access any controller/action, the application verifies that the
current role (in session) has access to it, otherwise it displays a message like the above and
forwards the flow to the home page.</p>
<p>Now let’s find out how the application accomplishes this. The first thing to know is that
there is a component called <a class="reference internal" href="dispatching.html"><em>Dispatcher</em></a>. It is informed about the route
found by the <a class="reference internal" href="routing.html"><em>Routing</em></a> component. Then, it is responsible for loading the
appropriate controller and execute the corresponding action method.</p>
<p>Normally, the framework creates the Dispatcher automatically. In our case, we want to perform a verification
before executing the required action, checking if the user has access to it or not. To achieve this, we have
replaced the component by creating a function in the bootstrap:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Dispatcher</span><span class="p">;</span>

<span class="c1">// ...</span>

<span class="sd">/**</span>
<span class="sd"> * MVC dispatcher</span>
<span class="sd"> */</span>
<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">'dispatcher'</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">// ...</span>

    <span class="nv">$dispatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Dispatcher</span><span class="p">;</span>

    <span class="k">return</span> <span class="nv">$dispatcher</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
<p>We now have total control over the Dispatcher used in the application. Many components in the framework trigger
events that allow us to modify their internal flow of operation. As the Dependency Injector component acts as glue
for components, a new component called <a class="reference internal" href="events.html"><em>EventsManager</em></a> allows us to intercept the events produced
by a component, routing the events to listeners.</p>
<div class="section" id="events-management">
<h3>Events Management<a class="headerlink" href="tutorial-invo-2.html#events-management" title="Permalink to this headline">¶</a>
</h3>
<p>An <a class="reference internal" href="events.html"><em>EventsManager</em></a> allows us to attach listeners to a particular type of event. The type that
interests us now is “dispatch”. The following code filters all events produced by the Dispatcher:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Mvc\Dispatcher</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Events\Manager</span> <span class="k">as</span> <span class="nx">EventsManager</span><span class="p">;</span>

<span class="nv">$di</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="s1">'dispatcher'</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="nv">$eventsManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventsManager</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * Check if the user is allowed to access certain action using the SecurityPlugin</span>
<span class="sd">     */</span>
    <span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span><span class="s1">'dispatch:beforeDispatch'</span><span class="p">,</span> <span class="k">new</span> <span class="nx">SecurityPlugin</span><span class="p">);</span>

    <span class="sd">/**</span>
<span class="sd">     * Handle exceptions and not-found exceptions using NotFoundPlugin</span>
<span class="sd">     */</span>
    <span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span><span class="s1">'dispatch:beforeException'</span><span class="p">,</span> <span class="k">new</span> <span class="nx">NotFoundPlugin</span><span class="p">);</span>

    <span class="nv">$dispatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Dispatcher</span><span class="p">;</span>
    <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">setEventsManager</span><span class="p">(</span><span class="nv">$eventsManager</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$dispatcher</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
<p>When an event called “beforeDispatch” is triggered the following plugin will be notified:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * Check if the user is allowed to access certain action using the SecurityPlugin</span>
<span class="sd"> */</span>
<span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span><span class="s1">'dispatch:beforeDispatch'</span><span class="p">,</span> <span class="k">new</span> <span class="nx">SecurityPlugin</span><span class="p">);</span>
</pre></div>
</div>
<p>When a “beforeException” is triggered then other plugin is notified:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * Handle exceptions and not-found exceptions using NotFoundPlugin</span>
<span class="sd"> */</span>
<span class="nv">$eventsManager</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span><span class="s1">'dispatch:beforeException'</span><span class="p">,</span> <span class="k">new</span> <span class="nx">NotFoundPlugin</span><span class="p">);</span>
</pre></div>
</div>
<p>SecurityPlugin is a class located at (app/plugins/SecurityPlugin.php). This class implements the method
“beforeDispatch”. This is the same name as one of the events produced in the Dispatcher:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Acl</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Events\Event</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Mvc\User\Plugin</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Mvc\Dispatcher</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">SecurityPlugin</span> <span class="k">extends</span> <span class="nx">Plugin</span>
<span class="p">{</span>

    <span class="c1">// ...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">beforeDispatch</span><span class="p">(</span><span class="nx">Event</span> <span class="nv">$event</span><span class="p">,</span> <span class="nx">Dispatcher</span> <span class="nv">$dispatcher</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>The hook events always receive a first parameter that contains contextual information of the event produced ($event)
and a second one that is the object that produced the event itself ($dispatcher). It is not mandatory that
plugins extend the class Phalcon\Mvc\User\Plugin, but by doing this they gain easier access to the services
available in the application.</p>
<p>Now, we’re verifying the role in the current session, checking if the user has access using the ACL list.
If the user does not have access we redirect to the home screen as explained before:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Acl</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Events\Event</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Mvc\User\Plugin</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Mvc\Dispatcher</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Security</span> <span class="k">extends</span> <span class="nx">Plugin</span>
<span class="p">{</span>

    <span class="c1">// ...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">beforeExecuteRoute</span><span class="p">(</span><span class="nx">Event</span> <span class="nv">$event</span><span class="p">,</span> <span class="nx">Dispatcher</span> <span class="nv">$dispatcher</span><span class="p">)</span>
    <span class="p">{</span>

        <span class="c1">//Check whether the "auth" variable exists in session to define the active role</span>
        <span class="nv">$auth</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">session</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'auth'</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$auth</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$role</span> <span class="o">=</span> <span class="s1">'Guests'</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$role</span> <span class="o">=</span> <span class="s1">'Users'</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//Take the active controller/action from the dispatcher</span>
        <span class="nv">$controller</span> <span class="o">=</span> <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">getControllerName</span><span class="p">();</span>
        <span class="nv">$action</span> <span class="o">=</span> <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">getActionName</span><span class="p">();</span>

        <span class="c1">//Obtain the ACL list</span>
        <span class="nv">$acl</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getAcl</span><span class="p">();</span>

        <span class="c1">//Check if the Role have access to the controller (resource)</span>
        <span class="nv">$allowed</span> <span class="o">=</span> <span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">isAllowed</span><span class="p">(</span><span class="nv">$role</span><span class="p">,</span> <span class="nv">$controller</span><span class="p">,</span> <span class="nv">$action</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$allowed</span> <span class="o">!=</span> <span class="nx">Acl</span><span class="o">::</span><span class="na">ALLOW</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">//If he doesn't have access forward him to the index controller</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">flash</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span><span class="s2">"You don't have access to this module"</span><span class="p">);</span>
            <span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">forward</span><span class="p">(</span>
                <span class="k">array</span><span class="p">(</span>
                    <span class="s1">'controller'</span> <span class="o">=&gt;</span> <span class="s1">'index'</span><span class="p">,</span>
                    <span class="s1">'action'</span>     <span class="o">=&gt;</span> <span class="s1">'index'</span>
                <span class="p">)</span>
            <span class="p">);</span>

            <span class="c1">//Returning "false" we tell to the dispatcher to stop the current operation</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="providing-an-acl-list">
<h3>Providing an ACL list<a class="headerlink" href="tutorial-invo-2.html#providing-an-acl-list" title="Permalink to this headline">¶</a>
</h3>
<p>In the above example we have obtained the ACL using the method $this-&gt;_getAcl(). This method is also
implemented in the Plugin. Now we are going to explain step-by-step how we built the access control list (ACL):</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Acl</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Acl\Role</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Acl\Adapter\Memory</span> <span class="k">as</span> <span class="nx">AclList</span><span class="p">;</span>

<span class="c1">// Create the ACL</span>
<span class="nv">$acl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AclList</span><span class="p">();</span>

<span class="c1">// The default action is DENY access</span>
<span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">setDefaultAction</span><span class="p">(</span><span class="nx">Acl</span><span class="o">::</span><span class="na">DENY</span><span class="p">);</span>

<span class="c1">// Register two roles, Users is registered users</span>
<span class="c1">// and guests are users without a defined identity</span>
<span class="nv">$roles</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'users'</span>  <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">Role</span><span class="p">(</span><span class="s1">'Users'</span><span class="p">),</span>
    <span class="s1">'guests'</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">Role</span><span class="p">(</span><span class="s1">'Guests'</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$roles</span> <span class="k">as</span> <span class="nv">$role</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">addRole</span><span class="p">(</span><span class="nv">$role</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now, we define the resources for each area respectively. Controller names are resources and their actions are
accesses for the resources:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Acl\Resource</span><span class="p">;</span>

<span class="c1">// ...</span>

<span class="c1">// Private area resources (backend)</span>
<span class="nv">$privateResources</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
  <span class="s1">'companies'</span>    <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'index'</span><span class="p">,</span> <span class="s1">'search'</span><span class="p">,</span> <span class="s1">'new'</span><span class="p">,</span> <span class="s1">'edit'</span><span class="p">,</span> <span class="s1">'save'</span><span class="p">,</span> <span class="s1">'create'</span><span class="p">,</span> <span class="s1">'delete'</span><span class="p">),</span>
  <span class="s1">'products'</span>     <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'index'</span><span class="p">,</span> <span class="s1">'search'</span><span class="p">,</span> <span class="s1">'new'</span><span class="p">,</span> <span class="s1">'edit'</span><span class="p">,</span> <span class="s1">'save'</span><span class="p">,</span> <span class="s1">'create'</span><span class="p">,</span> <span class="s1">'delete'</span><span class="p">),</span>
  <span class="s1">'producttypes'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'index'</span><span class="p">,</span> <span class="s1">'search'</span><span class="p">,</span> <span class="s1">'new'</span><span class="p">,</span> <span class="s1">'edit'</span><span class="p">,</span> <span class="s1">'save'</span><span class="p">,</span> <span class="s1">'create'</span><span class="p">,</span> <span class="s1">'delete'</span><span class="p">),</span>
  <span class="s1">'invoices'</span>     <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'index'</span><span class="p">,</span> <span class="s1">'profile'</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$privateResources</span> <span class="k">as</span> <span class="nv">$resource</span> <span class="o">=&gt;</span> <span class="nv">$actions</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">addResource</span><span class="p">(</span><span class="k">new</span> <span class="nx">Resource</span><span class="p">(</span><span class="nv">$resource</span><span class="p">),</span> <span class="nv">$actions</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Public area resources (frontend)</span>
<span class="nv">$publicResources</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
   <span class="s1">'index'</span>      <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'index'</span><span class="p">),</span>
   <span class="s1">'about'</span>      <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'index'</span><span class="p">),</span>
   <span class="s1">'register'</span>   <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'index'</span><span class="p">),</span>
   <span class="s1">'errors'</span>     <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'show404'</span><span class="p">,</span> <span class="s1">'show500'</span><span class="p">),</span>
   <span class="s1">'session'</span>    <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'index'</span><span class="p">,</span> <span class="s1">'register'</span><span class="p">,</span> <span class="s1">'start'</span><span class="p">,</span> <span class="s1">'end'</span><span class="p">),</span>
   <span class="s1">'contact'</span>    <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'index'</span><span class="p">,</span> <span class="s1">'send'</span><span class="p">)</span>
<span class="p">);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$publicResources</span> <span class="k">as</span> <span class="nv">$resource</span> <span class="o">=&gt;</span> <span class="nv">$actions</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">addResource</span><span class="p">(</span><span class="k">new</span> <span class="nx">Resource</span><span class="p">(</span><span class="nv">$resource</span><span class="p">),</span> <span class="nv">$actions</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The ACL now have knowledge of the existing controllers and their related actions. Role “Users” has access to
all the resources of both frontend and backend. The role “Guests” only has access to the public area:</p>
<div class="highlight-php">
<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Grant access to public areas to both users and guests</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$roles</span> <span class="k">as</span> <span class="nv">$role</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$publicResources</span> <span class="k">as</span> <span class="nv">$resource</span> <span class="o">=&gt;</span> <span class="nv">$actions</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">allow</span><span class="p">(</span><span class="nv">$role</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">(),</span> <span class="nv">$resource</span><span class="p">,</span> <span class="s1">'*'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Grant access to private area only to role Users</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$privateResources</span> <span class="k">as</span> <span class="nv">$resource</span> <span class="o">=&gt;</span> <span class="nv">$actions</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$actions</span> <span class="k">as</span> <span class="nv">$action</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$acl</span><span class="o">-&gt;</span><span class="na">allow</span><span class="p">(</span><span class="s1">'Users'</span><span class="p">,</span> <span class="nv">$resource</span><span class="p">,</span> <span class="nv">$action</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Hooray!, the ACL is now complete. In next chapter, we will see how a CRUD is implemented in Phalcon and how you
can customize it.</p>
</div>
</div>
</div>


                    </div>
                  </div>
                </div>
            </div>
          </td>
        </tr>
      </table>
    

      


    
    

  </body>
</html>
